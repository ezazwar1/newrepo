function createPromise(){var e={};return e.success=function(t){return e.successCallback=t,e},e.error=function(t){return e.errorCallback=t,e},e}function createPromise(){var e={};return e.success=function(t){return e.successCallback=t,e},e.error=function(t){return e.errorCallback=t,e},e}function createPromise(){var e={};return e.success=function(t){return e.successCallback=t,e},e.error=function(t){return e.errorCallback=t,e},e}function createPromise(){var e={};return e.success=function(t){return e.successCallback=t,e},e.error=function(t){return e.errorCallback=t,e},e}var servicesModule=angular.module("accountService",[]);servicesModule.factory("AccountService",["$http","$rootScope","$translate","$timeout","authHttp","Environment","StorageService","GeneralService","Token",function(e,t,i,n,o,a,r,s,c){function u(e){var t=e?e:{};return window.device&&(t.appVersion=a.getAppVersion(),t.cordovaVersion=device.cordova,t.model=device.model,t.platform=device.platform,t.uuid=device.uuid,t.version=device.version),t}function l(){h.offlineActivities.length>0&&o.post(a.serverURL+"/account/offline",{activities:h.offlineActivities}).success(function(){h.offlineActivities.length=0,r.removeItem("offlineActivities")})}function d(){r.setItem("accountUser",JSON.stringify(h.accountUser))}function f(){r.setItem("userPreferences",JSON.stringify(h.userPreferences))}function g(){r.setItem("offlineActivities",JSON.stringify(h.offlineActivities))}function v(){r.setItem("activityContext",JSON.stringify(h.activityContext))}function p(e,t){var i="";return e&&(i+="?startTime="+e.getTime()),t&&(i+=i.length>0?"&":"?",i+="endTime="+t.getTime()),i}function m(e){return e=e.toLowerCase(),e.startsWith("es")?e="es":e.startsWith("fr")?e="fr":"en-us"!=e&&"en-gb"!=e&&(e="en-us"),e}function b(e){h.setUserPreference("last_viewed_intro_date",s.getTodayString());var t=1<<e,i=+h.getUserPreference("viewed_intro_videos");i||(i=0);var n=i|t;h.setUserPreference("viewed_intro_videos",n)}var h={accountUser:{},userPreferences:{},experienceTips:{},activityContext:{},splitTestContext:{},userNotification:{},offlineActivities:[],refreshedStore:!1,locale:void 0,MOOD_VIDEO:0,RELAX_VIDEO:1,THOUGHTS_VIDEO:2,GOALS_VIDEO:3,HEALTH_VIDEO:4,COMMUNITY_VIDEO:5,FINAL_VIDEO:5,activities:{LOGIN:{name:"LOGIN",id:1,type:"account"},LOGOUT:{name:"LOGOUT",id:2,type:"account"},COMPLETED_BREATHING:{name:"COMPLETED_BREATHING",displayKey:"RELAX_ACTIVITY_DEEP_BREATHING",id:3,type:"relax",premium:!1},COMPLETED_RETHINK:{name:"COMPLETED_RETHINK",displayKey:"COMPLETE_A_THOUGHT_ENTRY",id:4,type:"thoughts",premium:!1},COMPLETED_EXPERIMENT:{name:"COMPLETED_EXPERIMENT",displayKey:"COMPLETE_AN_EXPERIMENT",id:5,type:"goals",premium:!1},COMPLETED_MUSCLE_RELAXATION:{name:"COMPLETED_MUSCLE_RELAXATION",displayKey:"RELAX_ACTIVITY_MUSCLE_RELAXATION",id:6,type:"relax",premium:!1},COMPLETED_POSITIVE_VISUALIZATION:{name:"COMPLETED_POSITIVE_VISUALIZATION",displayKey:"RELAX_VISUALIZE_HELP_TITLE",id:7,type:"relax",premium:!1},COMPLETED_MINDFULNESS:{name:"COMPLETED_MINDFULNESS",id:8,type:"relax",premium:!1},COMPLETED_JOURNAL:{name:"COMPLETED_JOURNAL",id:9,type:"thoughts",premium:!1},COMPLETED_UNGUIDED_MEDITATION:{name:"COMPLETED_UNGUIDED_MEDITATION",id:10,type:"relax",premium:!1},COMPLETED_SS_SOCIAL_SITUATIONS:{name:"COMPLETED_SS_SOCIAL_SITUATIONS",displayKey:"RELAX_ACTIVITY_SOCIAL_SITUATIONS",id:11,type:"relax",premium:!1},COMPLETED_SS_FLYING:{name:"COMPLETED_SS_FLYING",displayKey:"RELAX_ACTIVITY_FLYING",id:12,type:"relax",premium:!0},COMPLETED_SS_PUBLIC_SPEAKING:{name:"COMPLETED_SS_PUBLIC_SPEAKING",displayKey:"RELAX_ACTIVITY_PUBLIC_SPEAKING",id:13,type:"relax",premium:!0},COMPLETED_SS_PUBLIC_TRANSIT:{name:"COMPLETED_SS_PUBLIC_TRANSIT",displayKey:"RELAX_ACTIVITY_PUBLIC_TRANSIT",id:14,type:"relax",premium:!0},COMPLETED_MINDFUL_SENSES:{name:"COMPLETED_MINDFUL_SENSES",displayKey:"RELAX_ACTIVITY_MINDFUL_SENSES",id:15,type:"relax",premium:!1},COMPLETED_MINDFUL_BREATHE:{name:"COMPLETED_MINDFUL_BREATHE",displayKey:"RELAX_ACTIVITY_MINDFUL_BREATHE",id:16,type:"relax",premium:!0},COMPLETED_MINDFUL_OBSERVE:{name:"COMPLETED_MINDFUL_OBSERVE",displayKey:"RELAX_ACTIVITY_MINDFUL_OBSERVE",id:17,type:"relax",premium:!0},COMPLETED_MINDFUL_BODY_SCAN:{name:"COMPLETED_MINDFUL_BODY_SCAN",displayKey:"RELAX_ACTIVITY_MINDFUL_BODY_SCAN",id:18,type:"relax",premium:!0},COMPLETED_MINDFUL_WALK:{name:"COMPLETED_MINDFUL_WALK",displayKey:"RELAX_ACTIVITY_MINDFUL_WALK",id:19,type:"relax",premium:!0},COMPLETED_CALM_BREATHE:{name:"COMPLETED_CALM_BREATHE",displayKey:"RELAX_ACTIVITY_CALM_BREATHE",id:20,type:"relax",premium:!1},COMPLETED_CALM_MIND:{name:"COMPLETED_CALM_MIND",displayKey:"RELAX_ACTIVITY_CALM_MIND",id:21,type:"relax",premium:!0},COMPLETED_PANIC_EMERGENCY:{name:"COMPLETED_PANIC_EMERGENCY",displayKey:"RELAX_ACTIVITY_PANIC_EMERGENCY",id:22,type:"relax",premium:!0},COMPLETED_SLEEP:{name:"COMPLETED_SLEEP",displayKey:"RELAX_ACTIVITY_SLEEP",id:23,type:"relax",premium:!0},COMPLETED_GRATITUDE:{name:"COMPLETED_GRATITUDE",displayKey:"RELAX_ACTIVITY_GRATITUDE",id:24,type:"relax",premium:!0},COMPLETED_BECOMING_THE_TREE:{name:"COMPLETED_BECOMING_THE_TREE",displayKey:"RELAX_ACTIVITY_BECOME_TREE",id:25,type:"relax",premium:!0},COMPLETED_DIFFICULT_EXPERIENCE:{name:"COMPLETED_DIFFICULT_EXPERIENCE",displayKey:"RELAX_ACTIVITY_DIFFICULT_EXPERIENCE",id:26,type:"relax",premium:!0},COMPLETED_SELF_COMPASSION:{name:"COMPLETED_SELF_COMPASSION",displayKey:"RELAX_ACTIVITY_SELF_COMPASSION",id:27,type:"relax",premium:!0},COMPLETED_EMPATHY:{name:"COMPLETED_EMPATHY",displayKey:"RELAX_ACTIVITY_EMPATHY",id:31,type:"relax",premium:!0},COMPLETED_DEFUSION:{name:"COMPLETED_DEFUSION",displayKey:"RELAX_ACTIVITY_DEFUSION",id:28,type:"relax",premium:!0},COMPLETED_POSITIVE_RETHINK:{name:"COMPLETED_POSITIVE_RETHINK",displayKey:"COMPLETE_A_POSITIVE_THOUGHT_ENTRY",id:29,type:"thoughts",premium:!1},COMPLETED_GRATITUDE_JOURNAL:{name:"COMPLETED_GRATITUDE_JOURNAL",displayKey:"THOUGHTS_ACTIVITY_GRATITUDE",id:32,type:"thoughts",premium:!0},COMPLETED_POSITIVITY_JOURNAL:{name:"COMPLETED_POSITIVITY_JOURNAL",displayKey:"THOUGHTS_ACTIVITY_POSITIVITY",id:32,type:"thoughts",premium:!0}}};t.$on("event:pacificaReady",function(){r.getItem("accountUser",function(e){if(e){var t=JSON.parse(e);h.accountUser=t}}),r.getItem("userPreferences",function(e){if(e){var t=JSON.parse(e);h.userPreferences=t}}),r.getItem("offlineActivities",function(e){if(e){var t=JSON.parse(e);h.offlineActivities=t}}),r.getItem("activityContext",function(e){if(e){var t=JSON.parse(e);h.activityContext=t}}),r.getItem("splitTestContext",function(e){if(e)try{var t=JSON.parse(e);h.splitTestContext=t}catch(i){}})}),t.$on("event:online",function(){l()}),h.enablePremiumAccount=function(e,t){h.accountUser.account.premium=!0,h.accountUser.account.paymentType=t?t:"PURCHASE",h.accountUser.account.premiumExpiresAt=e,d()},h.getCategoryForActivity=function(e){var e=h.activities[e];return e?e.type:void 0},h.getDisplayForActivity=function(e){var e=h.activities[e];if(e){var t=e.displayKey;if(t)return i.instant(t)}},h.isActivityPremium=function(e){var e=h.activities[e];return e?e.premium:!1},h.enablePremiumFeatures=function(e,t,i,n){h.canUpgrade()?e&&("ios-appstore"==e.type?o.post(a.serverURL+"/account/verifyIOSPurchase",{transactionId:e.id,subscriptionId:t,receipt:e.appStoreReceipt,price:i},{transformResponse:void 0}).success(function(e){e&&"false"!=e&&h.enablePremiumAccount(e),n&&n(e)}).error(function(){n&&n(!1)}):"android-playstore"==e.type&&o.post(a.serverURL+"/account/verifyAndroidPurchase",{transactionId:e.id,subscriptionId:t,purchaseToken:e.purchaseToken,price:i}).success(function(e){e&&"false"!=e&&h.enablePremiumAccount(e),n&&n(e)}).error(function(){n&&n(!1)})):n(!0)},h.isLoggedIn=function(){return a.isWeb()?c.hasToken():!!h.accountUser.user},h.isPremiumEnabled=function(){var e=h.accountUser.account&&h.accountUser.account.premium===!0;if(e){var i=new Date(h.accountUser.account.premiumExpiresAt);e=i>new Date,e||"PURCHASE"!=h.accountUser.account.paymentType||h.refreshedStore||(h.refreshedStore=!0,t.$broadcast("event:refreshStore"))}return e},h.getPremiumExpiration=function(){var e=h.isPremiumEnabled()?new Date(h.accountUser.account.premiumExpiresAt):void 0;return e?moment(e).format("LLLL"):""},h.canUpgrade=function(){return!h.isPremiumEnabled()||"TRIAL"==h.accountUser.account.paymentType},h.findUserContext=function(){var e=u();return o.post(a.serverURL+"/account/context",e)},h.createAccount=function(t,i,n,r,s,c){var l={};o.addTimezone(l);var d={email:t,password:i,name:n,goal:s,lang:h.getLocale(),joinGroupCode:c,preventDefaultHabits:!1};return r&&(d.referralCode=r),u(d),l.withCredentials=!0,e.post(a.serverURL+"/account/createV2",d,l)},h.resetPassword=function(t){return e.post(a.serverURL+"/account/requestPasswordReset",t)},h.updateToken=function(e){o.update(e)},h.setNickname=function(e){var t=createPromise();return o.post(a.serverURL+"/account/name",e).success(function(){h.accountUser.user.name=e,d(),t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},h.setPublicNickname=function(e){return o.post(a.serverURL+"/account/publicName",e)},h.updateLocalPublicNickname=function(e){h.accountUser.user.publicName=e,d()},h.setAvatar=function(e){return h.getAccountUser().user.avatar=e,d(),o.post(a.serverURL+"/account/avatar",e)},h.getAvatarCharacter=function(e,t){if(1==t||1003==t||1001==t)return"pacifica";if(!e){var i=t%26;e=String.fromCharCode(97+i)}return e},h.setEmailAddress=function(e){var t=createPromise();return o.post(a.serverURL+"/account/email",e).success(function(){h.accountUser.user.email=e,h.accountUser.user.emailVerifiedAt=void 0,d(),t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},h.isEmailValidated=function(){var e=h.getAccountUser();return e&&e.user&&!!e.user.emailVerifiedAt},h.checkRemoteEmailValidation=function(){return o.get(a.serverURL+"/account/isEmailValidated")},h.setAccountUser=function(e){h.accountUser=e,d()},h.getAccountUser=function(){return h.accountUser},h.setUserPreferences=function(e){if(h.userPreferences={},e)for(var t=0;t<e.length;++t){var i=e[t];h.userPreferences[i.preference]=i.value}f()},h.getUserPreference=function(e){return h.userPreferences[e]},h.setUserNotification=function(e){h.userNotification=e},h.getUserNotification=function(){return h.userNotification},h.setSplitTestContext=function(e){h.splitTestContext=e,e&&r.setItem("splitTestContext",JSON.stringify(e))},h.getSplitTestContext=function(){return h.splitTestContext},h.isUMNUser=function(){var e=h.getSplitTestContext();return e&&e.splitTestGroups?!!e.splitTestGroups.umnPilot:!1},h.login=function(t,i){var n={};o.addTimezone(n),n.withCredentials=!0;var r={email:t,password:i};return u(r),e.post(a.serverURL+"/account/login",r,n)},h.clearData=function(){h.accountUser={},h.userPreferences={},h.activityContext={},h.splitTestContext={},h.userNotification={},h.offlineActivities=[],d(),f(),v(),g(),r.removeItem("lastAppRatingDay"),r.removeItem("offlineActivities")},h.setOffline=function(){return o.post(a.serverURL+"/account/setOffline")},h.logout=function(){return h.clearData(),o.post(a.serverURL+"/account/logout")},h.ping=function(){return o.get(a.serverURL+"/ping")},h.clearUserPreference=function(e){return delete h.userPreferences[e],o.post(a.serverURL+"/account/clearPreference",{preference:e})},h.setUserPreference=function(e,t){if("undefined"!=typeof t){if("boolean"==typeof t&&(t+=""),h.isLoggedIn()&&("undefined"==typeof h.userPreferences[e]||h.userPreferences[e]!=t)&&(h.userPreferences[e]=t,f(),h.isLoggedIn()))return o.post(a.serverURL+"/account/preference",{preference:e,value:t});var i,r={success:function(e){return i=e,this},error:function(){return this}};return n(function(){i&&i()}),r}},h.registerGCMToken=function(e,t){return o.post(a.serverURL+"/account/gcmToken",e).then(function(){},t)},h.registerAPNSToken=function(e){return o.post(a.serverURL+"/account/apnsToken",e)},h.recordActivity=function(e){var t=h.activityContext[e];t||(t=[],h.activityContext[e]=t),t.push({recordedAt:new Date}),v(),a.isOnline()?o.post(a.serverURL+"/account/activity",e):(h.offlineActivities.push({activity:e,timestamp:new Date}),g())},h.setActivityContext=function(e){h.activityContext=e.dailyActivities,v()},h.getActivities=function(e){return h.activityContext[e]},h.getActivityCount=function(e){var t=h.getActivities(e),i=0;if(t)for(var n=s.getTodayString(),o=0;o<t.length;++o){var a=t[o],r=new Date(a.recordedAtString?a.recordedAtString:a.recordedAt),c=s.getDayString(r);c==n&&++i}return i},h.getActivityContextV2=function(e,t){var i=p(e,t);return o.get(a.serverURL+"/activity/contextV2"+i)},h.getActivityHistory=function(e,t){var i="";return e&&(i+="?startTime="+e.getTime()),t&&(i+=i.length>0?"&":"?",i+="endTime="+t.getTime()),o.get(a.serverURL+"/activity/history"+i)},h.getDaysSinceSignup=function(){var e=0;if(h.accountUser.user){var t=h.accountUser.user,i=s.getDayString(new Date(t.createdAtStr)),n=new Date(i),o=new Date(s.getTodayString());e=s.getDifferenceInDays(n,o)}return e},h.getLang=function(e){var t=e,i=t.indexOf("-");return i>0&&(t=t.substring(0,i)),t},h.getLocale=function(){return h.locale},h.updateLocale=function(e){h.locale=m(e);var t=h.getLang(h.locale);$("body").removeClass("en"),$("body").removeClass("es"),$("body").removeClass("fr"),$("body").addClass(t),i.use(t),moment.locale(h.locale)},h.setLocale=function(e){h.locale=e,h.updateLocale(h.locale);var t=createPromise();e=m(e);var i=h.setUserPreference("preferred_locale",e);return i&&i.success(function(){t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},h.getPublicUser=function(e){return o.get(a.serverURL+"/account/publicUser?userId="+e)},h.getUserTimeZone=function(){var e,t=h.getUserPreference("preferred_timezone");if(t)e=t;else{var i=jstz.determine();jstz&&(e=i.name())}return e},h.resendValidationEmail=function(){return o.post(a.serverURL+"/account/sendValidateEmail")},h.checkForRatingPrompt=function(){var e=h.getUserPreference("viewed_rate_app_popup");e&&"false"!=e||window.AppRate&&r.getItem("lastAppRatingDay",function(e){if(e!=s.getTodayString()&&h.getDaysSinceSignup()>=3){var t,i=function(e){t=e},n=function(e){1==e||3==e?h.setUserPreference("viewed_rate_app_popup",!0):r.setItem("lastAppRatingDay",s.getTodayString())};AppRate.preferences.storeAppURL.ios="922968861",AppRate.preferences.storeAppURL.android="market://details?id=com.pacificalabs.pacifica",AppRate.preferences.callbacks.onRateDialogShow=i,AppRate.preferences.callbacks.onButtonClicked=n,AppRate.promptForRating(!0)}})},h.clearPasscode=function(){return h.getAccountUser().user.passcode=void 0,d(),o.post(a.serverURL+"/account/clearPasscode")},h.setPasscode=function(e){return h.getAccountUser().user.passcode=e,d(),o.post(a.serverURL+"/account/setPasscode",{passcode:e})},h.getDownloadGiftCodeToken=function(){return o.get(a.serverURL+"/payment/getGiftCodeDownloadToken")},h.redeemGiftCode=function(e){return o.post(a.serverURL+"/payment/redeemGiftCode",{code:e})},h.bulkPurchaseWithtoken=function(e,t,i,n,r,s,c,u,l,d,f,g){return o.post(a.serverURL+"/payment/bulkPurchase",{token:e,firstName:t,lastName:i,address1:n,address2:r,city:s,state:c,postalCode:u,country:l,subscription:d,coupon:f,purchases:g})},h.subscribeWithToken=function(e,t,i,n,r,s,c,u,l,d,f){return o.post(a.serverURL+"/payment/subscribeWithToken",{token:e,firstName:t,lastName:i,address1:n,address2:r,city:s,state:c,postalCode:u,country:l,subscription:d,coupon:f})},h.cancelSubscription=function(){return o.post(a.serverURL+"/payment/cancelSubscription")},h.hasViewedVideo=function(e){var t=+h.getUserPreference("viewed_intro_videos");t||(t=0);var i=1<<e;return(t&i)>0},h.completedIntroVideos=function(){return h.getLastViewedVideo()>=h.FINAL_VIDEO},h.getLastViewedVideo=function(){var e=h.getUserPreference("last_viewed_intro_video");return"undefined"==typeof e?-1:("string"==typeof e&&(e=+e),e)},h.canViewVideo=function(){return!0},h.viewedVideoToday=function(){var e=h.getUserPreference("last_viewed_intro_date");return e==s.getTodayString()};var T=["MOOD_ACTIVITY","RELAX_ACTIVITY","THOUGHTS_ACTIVITY","EXPERIMENTS_ACTIVITY","HEALTH_ACTIVITY","COMMUNITY","WEEK_ONE_COMPLETE"],E=["https://thinkpacifica.com/milo/mood","https://thinkpacifica.com/milo/relax","https://thinkpacifica.com/milo/thoughts","https://thinkpacifica.com/milo/goals","https://thinkpacifica.com/milo/health","https://thinkpacifica.com/milo/community","https://thinkpacifica.com/milo/summary"];return h.getVideoTitle=function(e){return i.instant(0==e&&h.isUMNUser()?"STRESS_ACTIVITY":T[e])},h.getShareableVideoLink=function(e){return E[e]},h.skipVideo=function(e){h.hasViewedVideo(e)||b(e)},h.viewVideo=function(e,t){function i(e){"boolean"!=typeof e&&(e="true"===e),e&&t&&t()}if(!(0>e||e>=6))if(window.plugins&&window.plugins.streamingMedia){var n=a.serverURL+"/media/introVideo/stream/"+e;o.get(n).success(function(t){h.hasViewedVideo(e)||b(e),window.plugins.streamingMedia.playVideo(t.url,{successCallback:i,shouldAutoClose:!0})}).error(function(){})}else b(e)},h.postJSError=function(e,t,i){o.post(a.serverURL+"/support/jserror",{msg:e,url:t,line:i})},h}]);var tokenModule=angular.module("pacificaAnalytics",[]);tokenModule.provider("$analytics",function(){var e=!1,t={initialize:function(i,n,o){window.ga&&(window.ga("create",i,{storage:"none",cookieDomain:"none",clientId:window.device?device.uuid:"abc123"}),window.ga("set","appName","Pacifica"),window.ga("set","appVersion",n),window.ga("set","checkProtocolTask",function(){}),window.ga("set","forceSSL",!0),window.ga("set","anonymizeIp",!0),e=!0,t.pageTrack(o))},eventTrack:function(t,i){window.ga&&e&&window.ga("send","event",i.category,t,i.label)},pageTrack:function(t){window.ga&&e&&(window.ga("set","screenName",t),window.ga("send","screenview",{screenName:t}))},setUserId:function(t){window.ga&&e&&window.ga("set","&uid",""+t)}};return{eventTrack:t.eventTrack,initialize:t.initialize,setUserId:t.setUserId,$get:function(){return t}}});var servicesModule=angular.module("audioService",[]);servicesModule.factory("AudioService",["$rootScope","$timeout","$translate","authHttp","TokenService","Environment","GeneralService","StorageService",function(e,t,i,n,o,a,r,s){function c(){if(d.audioContext.thoughts&&d.audioContext.thoughts.length>10){var e=$.extend(!0,{},d.audioContext);e.thoughts.splice(10,e.thoughts.length-10),s.setItem("audioContext",JSON.stringify(e))}else s.setItem("audioContext",JSON.stringify(d.audioContext))}function u(e){if(e.tags){for(var t=0;t<e.tags.length;++t)e.tags[t].recordingId=e.id;return n.post(a.serverURL+"/audio/tag",{tags:e.tags})}}function l(e,t){var i={};if(i.title=e.title,i.type=e.type,i.duration=e.duration,i.thoughtId=t,e.localUrl){var r=function(t){e.id=+t.response,u(e)},s=function(e){alert("An error has occurred: Code = "+e.code)},c=new FileUploadOptions;c.fileKey="file",c.fileName=e.title,c.mimeType=e.title.endsWith(".mp4")?"audio/mp4":"audio/amr",c.params=i;var l={Session:o.getToken()};if(c.headers=l,a.isOnline()&&window.FileTransfer){var d=new FileTransfer;d.upload(e.localUrl,encodeURI(a.serverURL+"/audio/upload"),r,s,c)}}else i.notes=e.notes,n.post(a.serverURL+"/audio/postTextRecording",i).success(function(t){e.id=+t,u(e)}).error(function(e){})}var d={audioContext:{},activeThoughtId:void 0,activeSources:{},activeTextThought:void 0,activeTextHighlights:void 0};d.setActiveThoughtId=function(e){d.activeThoughtId=e},d.getActiveThoughtId=function(){return d.activeThoughtId},d.setActiveSource=function(e,t){d.activeSources[e]=t},d.getActiveSource=function(e){return d.activeSources[e]},e.$on("event:pacificaReady",function(){s.getItem("audioContext",function(e){e&&(d.audioContext=JSON.parse(e))}),s.getItem("activeTextThought",function(e){e&&(d.activeTextThought=e)}),s.getItem("activeTextHighlights",function(e){e&&(d.activeTextHighlights=JSON.parse(e))})}),d.storeActiveTextThought=function(e){d.activeTextThought=e,s.setItem("activeTextThought",e)},d.getActiveTextThought=function(){return d.activeTextThought},d.clearActiveTextThought=function(){d.activeTextThought=void 0,localStorage.removeItem("activeTextThought"),d.clearActiveTextHighlight()},d.clearActiveTextHighlight=function(){d.activeTextHighlights=void 0,localStorage.removeItem("activeTextHighlights")},d.storeActiveTextHighlights=function(e){d.activeTextHighlights=e,s.setItem("activeTextHighlights",JSON.stringify(e))},d.getActiveTextHighlights=function(){return d.activeTextHighlights};var f;return d.setTextThoughtForReview=function(e){f=e},d.getTextThoughtForReview=function(){return f},d.setAudioContext=function(e){var t=[];if(d.audioContext.thoughts)for(var i=d.audioContext.thoughts.length-1;i>=0;--i){var n=d.audioContext.thoughts[i];isNumeric(n.id)||n.saving||t.push(n)}d.audioContext=e,d.audioContext.thoughts||(d.audioContext.thoughts=[]);for(var o=0;o<t.length;++o)d.audioContext.thoughts.push(t[o]);c()},d.logout=function(){d.audioContext={}},d.getThoughts=function(){return d.audioContext.thoughts},d.getThoughtCount=function(){return d.audioContext.totalThoughts},d.clearNonPersistedThoughts=function(){if(d.audioContext.thoughts)for(var e=d.audioContext.thoughts.length-1;e>=0;--e){var t=d.audioContext.thoughts[e];isNumeric(t.id)||t.saving||t.id==d.activeThoughtId||d.audioContext.thoughts.splice(e,1)}c()},d.getThought=function(e){if(d.audioContext.thoughts)for(var t=0;t<d.audioContext.thoughts.length;++t){var i=d.audioContext.thoughts[t];if(i.id==e||i.generatedId==e)return i}},d.createThought=function(e){d.clearNonPersistedThoughts();var t=i.instant(e?e:"THOUGHT_RECORD"),n=t.replace(/ /g,"\\s");n+="\\s[0-9]*";var o=new RegExp(n),a=0;if(d.audioContext.thoughts)for(var r=0;r<d.audioContext.thoughts.length;++r){var s=d.audioContext.thoughts[r].title;if(o.test(s)){var c=s.split(" "),u=parseInt(c[c.length-1]);u>a&&(a=u)}}var l=t+" "+(a+1),f={id:generateGUID(),title:l,createdAt:(new Date).getTime(),createdAtString:(new Date).toString(),recordings:{}};return d.audioContext.thoughts||(d.audioContext.thoughts=[]),d.audioContext.thoughts.splice(0,0,f),++d.audioContext.totalThoughts,f},d.addRecording=function(e,t,i,n,o,a){var r={id:generateGUID(),title:t,type:i,duration:n,recordedAt:(new Date).getTime(),recordedAtString:(new Date).toString(),localUrl:e,url:t,notes:a},s=d.getThought(o);return s.recordings[i]=r,r},d.addTags=function(e,t){for(var i=e.recordings.thought,n=[],o=0;o<t.length;++o){var a=t[o];n.push({tagTypeString:a.positive?"positive":"negative",tagTime:a.tagTime,tagString:a.tags.join(",")})}i.tags?Array.prototype.push.apply(i.tags,n):i.tags=n},d.postThought=function(e,t){var i=d.getThought(e);i.thoughtType=t,i.saving=!0,n.post(a.serverURL+"/audio/createThoughtWithType",{title:i.title,thoughtType:t}).success(function(e){i.generatedId=i.id,i.id=e;for(var t in i.recordings){var n=i.recordings[t];l(n,i.id)}d.clearActiveTextThought()})},d.archiveThought=function(e){var t=createPromise();if(d.audioContext.thoughts)for(var i=0;i<d.audioContext.thoughts.length;++i){var o=d.audioContext.thoughts[i];if(o.id==e){d.audioContext.thoughts.splice(i,1),n.post(a.serverURL+"/audio/archiveThought",e).success(function(){--d.audioContext.totalThoughts,t.successCallback&&t.successCallback()}).error(function(e){t.errorCallback&&t.errorCallback()});break}}return t},d.updateThoughtTitle=function(e,t){if(d.audioContext.thoughts)for(var i=0;i<d.audioContext.thoughts.length;++i){var o=d.audioContext.thoughts[i];if(o.id==e){o.title=t,c(),n.post(a.serverURL+"/audio/updateThoughtTitle",{thoughtId:e,title:t});break}}},d.loadMoreThoughts=function(e,t){var i=createPromise();return n.get(a.serverURL+"/audio/thoughts?offset="+e+"&limit="+t).success(function(e){if(e){d.audioContext.thoughts||(d.audioContext.thoughts=[]);for(var t=0;t<e.length;++t){for(var n=e[t],o=!1,a=0;a<d.audioContext.thoughts.length;++a){var r=d.audioContext.thoughts[a];if(r.id==n.id){o=!0;break}}o||d.audioContext.thoughts.push(n)}}i.successCallback&&i.successCallback()}).error(function(){i.errorCallback&&i.errorCallback()}),i},d}]);var servicesModule=angular.module("authService",[]);servicesModule.factory("authHttp",["$http","TokenService","Environment",function(e,t){var i={};i.update=function(e){var i=e(),n=i.session;if(n){var o=n.split(";"),a=o[0].split("=")[1],r=o[1].split("=")[1];t.update(a,r)}},i.removeSession=function(){t.clear()},i.addTimezone=function(e){if(e.headers=e.headers||{},i.preferredTimezone)e.headers.TimezoneLocale=i.preferredTimezone;else{var t=new Date,n="GMT"+-t.getTimezoneOffset()/60,o=jstz.determine();o&&(e.headers.TimezoneLocale=o.name()),e.headers.Timezone=n}},i.setPreferredTimezone=function(e){i.preferredTimezone=e};var n=function(e){e.headers=e.headers||{},e.headers.Session=t.getToken(),i.addTimezone(e)};return angular.forEach(["get","delete","head","jsonp"],function(t){i[t]=function(i,o){return o=o||{},n(o),o.withCredentials=!0,e[t](i,o)}}),angular.forEach(["post","put"],function(t){i[t]=function(i,o,a){return a=a||{},n(a),a.withCredentials=!0,e[t](i,o,a)}}),i}]);var servicesModule=angular.module("environmentService",[]);servicesModule.factory("Environment",["$rootScope","$translate","$ionicPlatform","$ionicDeploy","$ionicLoading","$ionicPopup",function(e,t,i,n,o,a){function r(){l.online=!0,e.$broadcast("event:online")}function s(){l.online=!1,e.$broadcast("event:offline")}function c(){navigator&&navigator.connection&&(l.online="none"!=navigator.connection.type,l.online?r():s())}var u={serverURL:"https://app.thinkpacifica.com:443/app",websocketURL:"wss://app.thinkpacifica.com/app",gaTrackingCode:"UA-55091509-4",isDebuggable:!1,development:!1,channel:"production"},l={online:!0,appVersion:"4.0.5"};return u.isDebug=function(){return!!u.isDebuggable},u.isWeb=function(){return!1},u.isWebDebug=function(){return!1},u.isStorageAllowed=function(){return!0},document.addEventListener("online",r,!1),document.addEventListener("offline",s,!1),document.addEventListener("deviceready",c,!1),u.isOnline=function(){return l.online},u.isDevelopment=function(){return u.development},u.isIos=function(){return window.device&&window.device.platform&&"ios"==window.device.platform.toLowerCase()},u.isIPad=function(){return window.device&&window.device.model&&window.device.model.indexOf("iPad")>=0},u.isAndroid=function(){return window.device&&window.device.platform&&"android"==window.device.platform.toLowerCase()},u.getAppVersion=function(){return l.appVersion},u.getGATrackingCode=function(){return u.gaTrackingCode},u.checkForUpdate=function(e){n.setChannel(u.channel),n.check().then(function(t){e(t)},function(t){e(!1)})},u.performUpdate=function(e){window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.keepAwake(),e.setUserPreference("viewed_update_popup","false"),n.setChannel(u.channel),o.show({template:t.instant("UPDATING_PACIFICA")+"<br>( 0%)"}),n.update().then(function(e){o.hide();a.alert({template:t.instant("UPDATE_SUCCESSFUL"),okText:t.instant("OK_GOT_IT"),okType:"button-default"});window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.allowSleepAgain()},function(e){o.hide();a.alert({template:t.instant("UPDATE_ERROR"),okText:t.instant("OK_GOT_IT"),okType:"button-default"});window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.allowSleepAgain()},function(e){var i=Math.floor(+e);10>i&&(i=" "+i),o.show({template:t.instant("UPDATING_PACIFICA")+"<br>("+i+"%)"})})},u}]);var servicesModule=angular.module("errorService",[]);servicesModule.factory("ErrorService",function(){return{errorMessage:null,setError:function(e){this.errorMessage=e},clear:function(){this.errorMessage=null}}}),servicesModule.factory("errorHttpInterceptor",["$q","$rootScope",function(e,t){return{responseError:function(i){return 401==i.status&&t.$broadcast("event:loginRequired"),e.reject(i)}}}]),servicesModule.config(["$httpProvider",function(e){e.interceptors.push("errorHttpInterceptor")}]);var servicesModule=angular.module("generalService",[]),EMAIL_REGEX=/^[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;servicesModule.factory("GeneralService",["Environment",function(){function e(e,t,i){e||(e=[0]),e=e.toLowerCase();var n=t.indexOf(e);return n>=0?i[n]:i[0]}function t(e,t){return e?10>e&&!t?"0"+e:""+e:t?"0":"00"}var i={COLORS:["#60d293","#5fe9c4","#5bdddf","#58caf6","#ffbe66","#ff9b73","#ff6669"],COLOR_NAMES:["green","turquoise","cyan","blue","yellow","orange","red"],STRESS_COLORS:["#60d293","#58caf6","#ffbe66","#ff9b73","#ff6669"],STRESS_COLOR_NAMES:["green","blue","yellow","orange","red"],MILLISECONDS_IN_HOUR:36e5,MILLISECONDS_IN_DAY:864e5};return i.isEmailValid=function(e){return EMAIL_REGEX.test(e)},i.getStressColor=function(t){return e(t,i.STRESS_COLOR_NAMES,i.STRESS_COLORS)},i.getColor=function(t){return e(t,i.COLOR_NAMES,i.COLORS)},i.getDifferenceInDays=function(e,t){var n=Math.abs(t-e);return Math.floor(n/i.MILLISECONDS_IN_DAY)},i.getTodayString=function(){var e=new Date;return i.getDayString(e)},i.getDayString=function(e){var t=e.getDate(),i=e.getMonth()+1,n=e.getFullYear();return n+"-"+(10>i?"0":"")+i+"-"+(10>t?"0":"")+t},i.getDateDisplay=function(e){var t=""+e.getFullYear();return t=t.substring(2),e.getMonth()+1+"/"+e.getDate()+"/"+t},i.getMinuteDisplay=function(e){var t=e.getMinutes(),i=e.getHours(),n=i;return 0===n?n=12:n>12&&(n-=12),n+":"+(10>t?"0":"")+t+(i>=12?"PM":"AM")},i.toTitleCase=function(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},i.getTimeDisplay=function(e,i){var n=Math.floor(e/60),o=Math.floor(e-60*n),a=t(n,i),r=t(o,!1);return a+":"+r},i.loadFile=function(e,t){function i(i){i.root.getFile(e,{create:!0,exclusive:!1},function(e){t(e)},function(){})}function n(){}window.LocalFileSystem&&window.requestFileSystem(LocalFileSystem.TEMPORARY,0,i,n)},i}]);var servicesModule=angular.module("goalsService",[]);servicesModule.factory("GoalsService",["$http","$rootScope","$timeout","authHttp","Environment","GeneralService","StorageService","AccountService",function(e,t,i,n,o,a,r,s){function c(){r.setItem("accountGoals",JSON.stringify(p.accountGoals))}function u(){r.setItem("accountSubGoals",JSON.stringify(p.accountSubGoals))}function l(e){isNumeric(e.id)&&isNumeric(e.goalId)&&e.achievedRecordedAtRequestUpdate&&v(e)}function d(){function e(e){e.createdOffline&&!isNumeric(e.id)&&isNumeric(e.goalId)&&(e.createdOffline=!1,n.post(o.serverURL+"/goals/account/addSubGoal",e).success(function(t){e.id=+t,u(),l(e)}).error(function(t){e.createdOffline=!1}))}var t=p.accountSubGoals;for(var i in t)for(var a=t[i],r=0;r<a.length;++r){var s=a[r];e(s)}}function f(e,t){function i(i){isNumeric(i.id)||i.goalId!=e?l(i):(i.goalId=t,u(),n.post(o.serverURL+"/goals/account/addSubGoal",i).success(function(e){i.id=+e,u(),l(i)}).error(function(e){}))}var a=p.accountSubGoals;for(var r in a)for(var s=a[r],c=0;c<s.length;++c){var d=s[c];i(d)}}function g(){function e(e){e.id&&isNumeric(e.id)||n.post(o.serverURL+"/goals/account/addGoal",{title:e.title,color:e.color}).success(function(t){var i=e.id;e.id=+t,f(i,e.id),c()}).error(function(e){})}d();for(var t=p.accountGoals,i=0;i<t.length;++i){var a=t[i];e(a)}}function v(e,t){if(e&&(p.achievedSubGoal(e)||(e.achievedRecordedAt=(new Date).getTime(),e.achievedRecordedAtString=(new Date).toString(),e.actualDifficulty=t,u(),s.recordActivity("COMPLETED_EXPERIMENT"))),o.isOnline())return n.post(o.serverURL+"/goals/account/achieveSubGoalWithDifficulty",{subGoalId:e.id,actualDifficulty:t});e.achievedRecordedAtRequestUpdate=!0;var a=createPromise();return i(function(){a.successCallback&&a.successCallback()}),a}var p={accountGoals:[],accountSubGoals:{},lastActiveTab:void 0};return t.$on("event:pacificaReady",function(){r.getItem("accountGoals",function(e){e&&(p.accountGoals=JSON.parse(e))}),r.getItem("accountSubGoals",function(e){e&&(p.accountSubGoals=JSON.parse(e))})}),p.logout=function(){p.accountGoals=[],p.accountSubGoals={}},p.getLastActiveTab=function(){return p.lastActiveTab},p.setLastActiveTab=function(e){p.lastActiveTab=e},p.setGoalContext=function(e){var t=p.accountGoals,i=p.accountSubGoals;
p.accountGoals=e.accountGoals,p.accountSubGoals=e.accountSubGoals;for(var n=0;n<t.length;++n){var o=t[n];if(o.createdOffline&&!isNumeric(o.createdOffline)){for(var a=!1,r=0;r<p.accountGoals.length;++r)if(p.accountGoals[r].id==o.id){a=!0;break}a||p.accountGoals.push(o)}}for(var s in i)for(var l=i[s],d=0;d<l.length;++d){var f=l[d];if(f.createdOffline&&!isNumeric(f.id)){for(var g=!1,v=p.accountSubGoals[s],m=0;l>m;++m)if(v[m].id==f.id){g=!0;break}g||(p.accountSubGoals[s]||(p.accountSubGoals[s]=[]),p.accountSubGoals[s].push(f))}}c(),u()},p.getAccountGoals=function(){return p.accountGoals},p.getAccountSubGoals=function(){return p.accountSubGoals},p.getGoal=function(e){for(var t,i=p.accountGoals,n=0;n<i.length;++n)if(i[n].id==e){t=i[n];break}return t},p.getSubGoalById=function(e){for(var t in p.accountSubGoals)for(var i=p.accountSubGoals[t],n=0;n<i.length;++n){var o=i[n];if(o.id==e)return o}return void 0},p.getSubGoal=function(e,t){var i,n=p.accountSubGoals[e];if(n)for(var o=0;o<n.length;++o)if(n[o].id==t){i=n[o];break}return i},p.getTodaysAchievedGoals=function(){var e=[],t=p.accountSubGoals;for(var i in t)for(var n=t[i],o=0;o<n.length;++o){var a=n[o];p.achievedSubGoalToday(a)&&e.push(a)}return e},p.achievedSubGoal=function(e){return null!==e.achievedRecordedAt&&"undefined"!=typeof e.achievedRecordedAt},p.achievedSubGoalToday=function(e){if(p.achievedSubGoal(e)){var t=new Date(e.achievedRecordedAtString),i=a.getDayString(t);return i==a.getDayString(new Date)}return!1},t.$on("event:online",function(){g()}),p.addGoal=function(e,t){var a={title:e,color:t,createdAt:(new Date).getTime()};p.accountGoals.push(a),c();var r,s=createPromise();return o.isOnline()?n.post(o.serverURL+"/goals/account/addGoal",{title:e,color:t}).success(function(e){a.id=+e,c(),s.successCallback&&s.successCallback(e)}).error(function(e){s.errorCallback&&s.errorCallback()}):(a.id=generateGUID(),a.createdOffline=!0,c(),i(function(){r&&r()})),s},p.archiveGoal=function(e){for(var t=p.accountGoals,i=0;i<t.length;++i)if(t[i].id==e){t.splice(i,1),c();for(var a in p.accountSubGoals)for(var r=p.accountSubGoals[a],s=r.length-1;s>=0;--s){var l=r[s];l.goalId==e&&r.splice(s,1)}u();break}return n.post(o.serverURL+"/goals/account/archiveGoal",e)},p.updateGoal=function(e,t,i){var a=p.getGoal(e);return a?(a.title=t,a.color=i,c(),o.isOnline()?n.post(o.serverURL+"/goals/account/updateGoal",{goalId:a.id,title:a.title,color:a.color}):{success:function(e){e&&e()}}):void 0},p.addSubGoal=function(e,t,a,r){var s={goalId:e,title:t,day:a,difficulty:r,createdAt:(new Date).getTime()},c=p.accountSubGoals[a];c||(c=[],p.accountSubGoals[a]=c),c.push(s),u();var l=createPromise();return o.isOnline()?n.post(o.serverURL+"/goals/account/addSubGoal",s).success(function(e){s.id=+e,u(),l.successCallback&&l.successCallback()}).error(function(e,t,i,n){l.errorCallback&&l.errorCallback(e,t,i,n)}):(s.id=generateGUID(),s.createdOffline=!0,u(),i(function(){l.successCallback&&l.successCallback()})),l},p.achieveSubGoal=function(e,t){var i=p.getSubGoalById(e);return v(i,t)},p.archiveSubGoal=function(e,t){var i=p.accountSubGoals[e];if(i){var a=p.getSubGoal(e,t),r=i.indexOf(a);if(r>=0)return i.splice(r,1),u(),n.post(o.serverURL+"/goals/account/archiveSubGoal",t)}},p.updateSubGoal=function(e,t,a,r,s){var c=p.getSubGoal(r,e);if(c&&(c.goalId=t,c.day=r,c.title=a,c.difficulty=s,u(),o.isOnline()))return n.post(o.serverURL+"/goals/account/updateSubGoal",{subGoalId:e,goalId:t,title:a,day:r,difficulty:s});var l=createPromise();return i(function(){l.successCallback&&l.successCallback()}),l},p}]);var servicesModule=angular.module("groupsService",[]);servicesModule.factory("GroupsService",["$http","$rootScope","$timeout","$translate","authHttp","Environment","AccountService","GeneralService","StorageService",function(e,t,i,n,o,a,r,s,c){function u(e){var t=new Date((new Date).getTime()+9e5);v.nextAllowedPosts[e.id]=t,c.setItem("nextAllowedPosts",JSON.stringify(v.nextAllowedPosts))}function l(e){var t=new Date((new Date).getTime()+3e5);v.nextAllowedComments[e]=t,c.setItem("nextAllowedComments",JSON.stringify(v.nextAllowedComments))}function d(){var e={};return e.success=function(t){return e.successCallback=t,e},e.error=function(t){return e.errorCallback=t,e},e}function f(){var e=r.getUserNotification();if(e.groupNotificationCount=0,e.communityNotificationCount=0,e){if(e.postNotifications)for(var t in e.postNotifications){var i=e.postNotifications[t];i&&(e.communityNotificationCount+=i.actions)}if(e.groupNotifications)for(var n in e.groupNotifications){var o=e.groupNotifications[n];o&&(e.groupNotificationCount+=o.actions)}}}function g(e,t,i){var n=e.curatedGroups[t];n||(n=[],e.curatedCategories.push(t),e.curatedGroups[t]=n),n.push(i)}var v={userGroupContext:void 0,publicGroupContext:void 0,publicGroupsById:{},profileLikes:void 0,profileShares:void 0,profileComments:void 0,lastActiveTab:"communities",nextAllowedPosts:{},nextAllowedComments:{},nextUserGroupUpdate:void 0,nextPublicGroupUpdate:void 0,nextProfileSharesUpdate:void 0,lastProfileSharesOffset:0,nextProfileLikesUpdate:void 0,lastProfileLikesOffset:0,nextProfileCommentsUpdate:void 0,nextProfileCommentsOffset:0};v.logout=function(){v.userGroupContext=void 0,v.publicGroupContext=void 0,v.publicGroupsById={},v.profileLikes=void 0,v.profileShares=void 0,v.nextUserGroupUpdate=void 0,v.nextPublicGroupUpdate=void 0,v.nextProfileSharesUpdate=void 0,v.lastProfileSharesOffset=0,v.nextProfileLikesUpdate=void 0,v.lastProfileLikesOffset=0,v.nextProfileCommentsUpdate=void 0,v.nextProfileCommentsOffset=0,v.lastActiveTab="communities"},t.$on("event:pacificaReady",function(){c.getItem("nextAllowedPosts",function(e){e&&(v.nextAllowedPosts=JSON.parse(e))}),c.getItem("nextAllowedComments",function(e){e&&(v.nextAllowedComments=JSON.parse(e))}),c.getItem("lastActiveGroupsTab",function(e){e&&(v.lastActiveTab=e)})}),v.getLastActiveTab=function(){var e=r.getAccountUser().user,t=new Date(e.createdAtStr).getTime(),i=(new Date).getTime();return!savedLastActiveTab&&i>t+864e5?"groups":v.lastActiveTab},v.setLastActiveTab=function(e){v.lastActiveTab=e,c.setItem("lastActiveGroupsTab",e),savedLastActiveTab=e},v.findPublicGroupName=function(e){var t=v.publicGroupsById[e];return t?t.name:void 0},v.findPublicGroups=function(e){var t=d();return e||!v.publicGroupContext||!v.nextPublicGroupUpdate||v.nextPublicGroupUpdate<new Date?o.get(a.serverURL+"/groups/public").success(function(e){if(v.publicGroupContext=e,v.publicGroupContext.publicGroups)for(var i=0;i<v.publicGroupContext.publicGroups.length;++i){var n=v.publicGroupContext.publicGroups[i];v.publicGroupsById[n.id]=n}v.publicGroupContext.nextAllowedPostStr&&(v.nextAllowedPost=new Date(v.publicGroupContext.nextAllowedPostStr)),v.nextPublicGroupUpdate=new Date((new Date).getTime()+3e5),t.successCallback&&t.successCallback(e)}).error(function(e){t.errorCallback&&t.errorCallback()}):i(function(){t.successCallback&&t.successCallback(v.publicGroupContext)}),t},v.getCachedUserGroups=function(){return v.userGroupContext},v.findUserGroups=function(e){var t=d();return e||!v.userGroupContext||!v.nextUserGroupUpdate||v.nextUserGroupUpdate<new Date?o.get(a.serverURL+"/groups/user").success(function(e){v.userGroupContext=e,v.nextUserGroupUpdate=new Date((new Date).getTime()+6e4),t.successCallback&&t.successCallback(e)}).error(function(e){t.errorCallback&&t.errorCallback()}):(i(function(){t.successCallback&&t.successCallback(v.userGroupContext)}),o.get(a.serverURL+"/groups/invites").success(function(e){v.userGroupContext&&(v.userGroupContext.pendingInvites.length=0,v.userGroupContext.pendingInvites.push.apply(v.userGroupContext.pendingInvites,e))}).error(function(e){})),t};var p,m={},b={};v.storeCachedPost=function(e,t,i){m[e.id]=e,b=t,p=i},v.getCachedPost=function(e){return m[e]},v.getCachedPostData=function(e){return b?b[e]:void 0},v.getCachedUserVotes=function(){return p},v.getGroupImmediate=function(e){for(var t=v.userGroupContext.userGroups,i=0;i<t.length;++i){var n=t[i];if(n.id==e)return n}for(var o=0;o<v.publicGroupContext.publicGroups.length;++o){var a=v.publicGroupContext.publicGroups[o];if(a.id==e)return a}},v.getGroup=function(e){function t(){for(var t=v.userGroupContext.userGroups,i=0;i<t.length;++i){var n=t[i];if(n.id==e){o.successCallback&&o.successCallback(n);break}}}function n(){for(var t=0;t<v.publicGroupContext.publicGroups.length;++t){var i=v.publicGroupContext.publicGroups[t];if(i.id==e){o.successCallback&&o.successCallback(i);break}}}var o=d();return v.userGroupContext?i(t):v.findUserGroups().success(function(){t()}).error(function(){o.errorCallback&&o.errorCallback()}),v.publicGroupContext&&v.publicGroupContext.publicGroups?i(n):v.findPublicGroups().success(function(){n()}).error(function(){o.errorCallback&&o.errorCallback()}),o},v.getGroupPost=function(e){return o.get(a.serverURL+"/groups/post?postId="+e)},v.findGroupPostComments=function(e,t,i,n){return o.get(a.serverURL+"/groups/posts/comments/?postId="+e+"&order="+t+"&limit="+i+"&offset="+n)},v.findGroupPosts=function(e,t,i,n){return o.get(a.serverURL+"/groups/posts?groupId="+e.id+"&order="+t+"&limit="+i+"&offset="+n)},v.findNewerPosts=function(e,t){return o.get(a.serverURL+"/groups/posts/newer?groupId="+e.id+"&lastTime="+t.getTime())},v.canCreatePublicGroupPost=function(e){var t=v.nextAllowedPosts[e.id];return"string"==typeof t&&(t=new Date(t)),!t||new Date>t},v.canCreatePublicComment=function(e){var t=v.nextAllowedComments[e];return"string"==typeof t&&(t=new Date(t)),!t||new Date>t},v.postComment=function(e,t,i){var n=d();return o.post(a.serverURL+"/groups/post/comment",{postId:e,groupId:t,title:i}).success(function(e){l(t),n.successCallback&&n.successCallback(e)}).error(function(){n.errorCallback&&n.errorCallback()}),n},v.createGroupPost=function(e,t,i){var n=d();return o.post(a.serverURL+"/groups/post",{groupId:e,title:t,postData:i}).success(function(t){var i=v.getGroupImmediate(e);i.private||(v.publicGroupContext.userShares++,v.profileShares=void 0,u(i),r.recordActivity("POSTED_TO_COMMUNITY")),n.successCallback&&n.successCallback(t)}).error(function(){n.errorCallback&&n.errorCallback()}),n},v.archiveComment=function(e){return o.post(a.serverURL+"/groups/post/comment/archive",{postCommentId:e})},v.archivePost=function(e){var t=d();return o.post(a.serverURL+"/groups/post/archive",{postId:e}).success(function(e){v.profileShares=void 0,t.successCallback&&t.successCallback(e)}).error(function(){t.errorCallback&&t.errorCallback()}),t},v.reportPost=function(e,t,i){var n=d();return o.post(a.serverURL+"/groups/post/report",{postId:e,reason:t,refer:i}).success(function(e){v.profileLikes=void 0,n.successCallback&&n.successCallback(e)}).error(function(){n.errorCallback&&n.errorCallback()}),n},v.reportComment=function(e,t,i){return o.post(a.serverURL+"/groups/post/comment/report",{postCommentId:e,reason:t,refer:i})},v.archiveGroup=function(e){var t=d();return o.post(a.serverURL+"/groups/archive",{groupId:e}).success(function(){if(v.userGroups)for(var i=0;i<v.userGroups.length;++i){var n=v.userGroups[i];if(n.id==e){v.userGroups.splice(i,1);break}}t.successCallback&&t.successCallback()}).error(function(e){t.errorCallback&&t.errorCallback()}),t},v.editGroup=function(e,t,i,n,r){var s=d();return o.post(a.serverURL+"/groups/edit",{groupId:e,name:t,nickname:i,description:n,searchable:r}).success(function(){var o=v.getGroupImmediate(e);o.name=t,o.nickname=i,o.description=n,o.searchable=r,s.successCallback&&s.successCallback(o)}).error(function(e,t,i,n){s.errorCallback&&s.errorCallback(e,t,i,n)}),s},v.editGroupNickname=function(e,t){var i=d();return o.post(a.serverURL+"/groups/editNickname",{groupId:e,nickname:t}).success(function(){var n=v.getGroupImmediate(e);n.nickname=t,i.successCallback&&i.successCallback(n)}).error(function(e,t,n,o){i.errorCallback&&i.errorCallback(e,t,n,o)}),i},v.createGroup=function(e,t,i,n){var r=d();return o.post(a.serverURL+"/groups/create",{name:e,nickname:t,description:i,searchable:n}).success(function(e){v.userGroupContext.userGroups||(v.userGroupContext.userGroups=[]),v.userGroupContext.userGroups.push(e),r.successCallback&&r.successCallback(e)}).error(function(e,t,i,n){r.errorCallback&&r.errorCallback(e,t,i,n)}),r},v.removeVote=function(e){var t=d();return o.post(a.serverURL+"/groups/post/removeVote",{postId:e.id}).success(function(){v.profileLikes=void 0,t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},v.voteUp=function(e,t){var i=d();return o.post(a.serverURL+"/groups/post/voteUp",{postId:e,groupId:t}).success(function(){v.profileLikes=void 0,i.successCallback&&i.successCallback()}).error(function(){i.errorCallback&&i.errorCallback()}),i},v.clearAllPostNotifications=function(){var e=r.getUserNotification();e&&e.postNotifications&&o.post(a.serverURL+"/groups/post/clearAllNotifications").success(function(){e.postNotifications.cleared=!0}).error(function(){})},v.clearPostNotification=function(e){var t=r.getUserNotification();if(t&&t.postNotifications){var i=t.postNotifications[e];i&&o.post(a.serverURL+"/groups/post/clearNotification",{postId:e}).success(function(){delete t.postNotifications[e],f()}).error(function(){})}},v.clearAllGroupNotifications=function(){var e=r.getUserNotification();e&&e.groupNotifications&&o.post(a.serverURL+"/groups/group/clearAllNotifications").success(function(){e.groupNotifications.cleared=!0}).error(function(){})},v.clearGroupNotification=function(e){var t=r.getUserNotification();if(t&&t.groupNotifications){var i=t.groupNotifications[e];i&&o.post(a.serverURL+"/groups/group/clearNotification",{groupId:e}).success(function(){delete t.groupNotifications[e],f()}).error(function(){})}},v.hasPostNotification=function(e){return v.getPostNotificationCount(e)>0},v.getPostNotificationCount=function(e){var t=r.getUserNotification();if(t.postNotifications){if(!e){if(t.postNotifications.cleared)return 0;var i=0;for(var n in t.postNotifications){var o=t.postNotifications[n];i+=o.actions}return i}var a=t.postNotifications[e];if(a)return a.actions}return 0},v.hasGroupNotification=function(e){var t=r.getUserNotification();if(t.groupNotifications){var i=t.groupNotifications[e];return!!i}return!1},v.getGroupNotificationCount=function(e){var t=r.getUserNotification();if(t.groupNotifications){if(!e){if(t.groupNotifications.cleared)return 0;var i=0;for(var n in t.groupNotifications){var o=t.groupNotifications[n];i+=o.actions}return i}var a=t.groupNotifications[e];if(a)return a.actions}return 0},v.removeCommentVote=function(e){return o.post(a.serverURL+"/groups/post/comment/removeVote",{postCommentId:e.id})},v.voteCommentUp=function(e,t,i){return o.post(a.serverURL+"/groups/post/comment/voteUp",{postCommentId:e,postId:t,groupId:i})},v.inviteExistingUser=function(e,t,i){return o.post(a.serverURL+"/groups/inviteExistingUser",{groupId:e,userId:t,text:i})},v.sendInvites=function(e,t,i){return o.post(a.serverURL+"/groups/sendInvites",{groupId:e,emails:t,text:i})},v.acceptInvite=function(e,t){return o.post(a.serverURL+"/groups/acceptInvite",{groupId:e,nickname:t})},v.joinGroup=function(e,t){return o.post(a.serverURL+"/groups/joinGroup",{groupCode:e,nickname:t})},v.joinRandomGroup=function(e,t){return o.post(a.serverURL+"/groups/joinRandomGroup",{goal:e,language:t})},v.deleteInvite=function(e,t){var i={groupId:e};return t&&(i.email=t),o.post(a.serverURL+"/groups/deleteInvite",i)},v.leaveGroup=function(e){var t=d();return o.post(a.serverURL+"/groups/leave",{groupId:e}).success(function(){if(v.userGroupContext.userGroups)for(var i=0;i<v.userGroupContext.userGroups.length;++i){var n=v.userGroupContext.userGroups[i];if(n.id==e){v.userGroupContext.userGroups.splice(i,1);break}}t.successCallback&&t.successCallback()}).error(function(e){t.errorCallback&&t.errorCallback()}),t},v.getShares=function(e,t,n){var r=d();if(n||!v.profileShares||v.lastProfileSharesOffset!=t||!v.nextProfileSharesUpdate||v.nextProfileSharesUpdate<new Date){v.lastProfileSharesOffset=t;var s=a.serverURL+"/groups/shares?limit="+e+"&offset="+t;n&&(s+="&userId="+n),o.get(s).success(function(e){n||(v.profileShares=e,v.nextProfileSharesUpdate=new Date((new Date).getTime()+3e5)),r.successCallback&&r.successCallback(e)}).error(function(e){r.errorCallback&&r.errorCallback()})}else i(function(){r.successCallback&&r.successCallback(v.profileShares)});return r},v.getUserLikes=function(e){if(!e||0===e.length)return d();for(var t=a.serverURL+"/groups/userLikes?ids=",i=0;i<e.length;++i)i>0&&(t+="&ids="),t+=e[i].id;return o.get(t)},v.getUserCommentLikes=function(e){if(!e||0===e.length)return d();for(var t=a.serverURL+"/groups/userCommentLikes?ids=",i=0;i<e.length;++i)i>0&&(t+="&ids="),t+=e[i].id;return o.get(t)},v.getLikes=function(e,t,n){var r=d();if(n||!v.profileLikes||v.lastProfileLikesOffset!=t||!v.nextProfileLikesUpdate||v.nextProfileLikesUpdate<new Date){v.lastProfileLikesOffset=t;var s=a.serverURL+"/groups/likes?limit="+e+"&offset="+t;n&&(s+="&userId="+n),o.get(s).success(function(e){n||(v.profileLikes=e,v.nextProfileLikesUpdate=new Date((new Date).getTime()+6e4)),r.successCallback&&r.successCallback(e)}).error(function(e){r.errorCallback&&r.errorCallback()})}else i(function(){r.successCallback&&r.successCallback(v.profileLikes)});return r},v.getComments=function(e,t,n){var r=d();if(n||!v.profileComments||v.lastProfileCommentsOffset!=t||!v.nextProfileCommentsUpdate||v.nextProfileCommentsUpdate<new Date){v.lastProfileCommentsOffset=t;var s=a.serverURL+"/groups/comments?limit="+e+"&offset="+t;n&&(s+="&userId="+n),o.get(s).success(function(e){n||(v.profileComments=e,v.nextProfileCommentsUpdate=new Date((new Date).getTime()+6e4)),r.successCallback&&r.successCallback(e)}).error(function(e){r.errorCallback&&r.errorCallback()})}else i(function(){r.successCallback&&r.successCallback(v.profileComments)});return r},v.getGroupUsers=function(e){return o.get(a.serverURL+"/groups/users?groupId="+e)},v.removeUser=function(e,t){return o.post(a.serverURL+"/groups/removeUser",{groupId:e,userId:t})},v.findCuratedGroups=function(){return o.get(a.serverURL+"/groups/curated")},v.initializeCuratedGroups=function(e,t){e.curatedGroups=void 0,e.curatedCategories=[];var i=v.userGroupContext?v.userGroupContext.userGroups:void 0;if(t&&t.length>0){e.curatedGroups={};for(var n=0;n<t.length;++n){var o=t[n],a=!1;if(i)for(var r=0;r<i.length;++r)if(i[r].id==o.id){a=!0;break}if(!a)if(o.curatedCategories){var s=o.curatedCategories.split(";");if(s.length>0)for(var c=0;c<s.length;++c)g(e,s[c],o)}else g(e,"Other",o)}if(e.curatedCategories.length>0){e.curatedCategories.sort();for(var u in e.curatedGroups){var l=e.curatedGroups[u];l.sort(function(e,t){return e.name.localeCompare(t.name)})}}}};var h=0;return v.searchForGroup=function(e){++h;var t=d();return o.get(a.serverURL+"/groups/search?query="+e+"&searchId="+h).success(function(e){e.searchId==h&&t.successCallback&&t.successCallback(e.groups)}).error(function(e){t.errorCallback&&t.errorCallback()}),t},v}]);var servicesModule=angular.module("habitsService",[]),MILLISECONDS_IN_HOUR=36e5,MILLISECONDS_IN_DAY=24*MILLISECONDS_IN_HOUR;servicesModule.factory("HabitsService",["$http","$rootScope","$timeout","$translate","authHttp","Environment","GeneralService","AccountService","StorageService",function(e,t,i,n,o,a,r,s,c){function u(){var e={};return e.success=function(t){return e.successCallback=t,e},e.error=function(t){return e.errorCallback=t,e},e}function l(){O.accountHabitValues=[];for(var e=0;e<O.accountHabits.length;++e)for(var t=O.accountHabits[e].habitValues,i=0;i<t.length;++i){var n=t[i];O.accountHabitValues[n.id]=n}}function d(){c.setItem("accountHabits",JSON.stringify(O.accountHabits))}function f(){c.setItem("habitData",JSON.stringify(O.habitData))}function g(){c.setItem("offlineHabitData",JSON.stringify(O.offlineHabitData))}function v(){c.setItem("recentFeelings",JSON.stringify(O.recentFeelings))}function p(){if(O.offlineHabitData.length>0){for(var e=[],t=0;t<O.offlineHabitData.length;++t){var i=O.offlineHabitData[t],n=O.getHabitValueById(i.habitValueId),r=O.getAccountHabitById(n.habitId),s={habitId:r.id,habitValueId:n.id,habitSubValueIds:i.subValueIds,experiencedAt:i.experiencedAt,notes:i.notes};i.update&&(s.habitDataId=i.id,s.update=!0),e.push(s)}o.post(a.serverURL+"/habits/offline",{data:e}).success(function(e){if(e)for(var t=0;t<e.length;++t)_(e[t]);O.offlineHabitData.length=0,c.removeItem("offlineHabitData")})}}function m(){O.accountHabits=[],O.accountHabitValues=[],O.potentialHabits=[],O.habitData={},P=!1,O.recentFeelings=[],c.removeItem("accountHabits"),c.removeItem("habitData"),c.removeItem("offlineHabitData"),U=!1}function b(e){new Date;e.update=!1,O.offlineHabitData.push(e),g()}function h(e,t){for(var i=e.habitValues.length-1;i>=0;--i){var n=e.habitValues[i];if(t>=n.valueInt)return i}}function T(e){for(var t=!1,i=0;i<O.offlineHabitData.length;++i){var n=O.offlineHabitData[i],o=O.getHabitValueById(n.habitValueId),a=O.getAccountHabitById(o.habitId),s=O.getHabitValueById(e.habitValueId),c=O.getAccountHabitById(s.habitId);if(a.id==c.id&&r.getDayString(n.experiencedAt)==r.getDayString(e.experiencedAt)){n.habitValueId=e.habitValueId,n.habitSubValueIds=e.subValueIds,n.notes=e.notes,t=!0;break}}t||(e.update="number"==typeof e.id,O.offlineHabitData.push(e)),g()}function E(e){var t=[];for(var i in O.habitData)t.push(i);t.sort(function(e,t){return new Date(t)-new Date(e)});for(var n=0,o=!1,a=0;a<t.length&&!o;++a){var r=t[a],s=O.habitData[r],c=s[1];if(c)for(var u=0;u<c.length;++u){var l=c[u],d=O.getHabitValueById(l.habitValueId);if(!e(d.valueInt)){o=!0;break}if(++n,n>=5){o=!0;break}}}return n>=5}function C(e){var t=e.experiencedAt;("number"==typeof t||"string"==typeof t)&&(t=new Date(t));var i=O.getHabitValueById(e.habitValueId),n=O.getAccountHabitById(i.habitId),o=O.getHabitDataList(n,t,!0);o.splice(0,0,e),f()}function _(e){var t=e.experiencedAt;("number"==typeof t||"string"==typeof t)&&(t=new Date(t));var i=O.getHabitValueById(e.habitValueId),n=O.getAccountHabitById(i.habitId),o=O.getHabitDataList(n,t,!0),a=o[0];a&&(o[0]=e,f())}function I(e){for(var t=0;t<O.recentFeelings.length;++t)if(O.recentFeelings[t].id==e.id)return;O.recentFeelings.splice(0,0,e)}function y(e,t){var i=new Date,n=new Date(i.getTime()-t*MILLISECONDS_IN_DAY);n.setHours(0,0,0,0);var o=new Date(n.getTime()-6*MILLISECONDS_IN_HOUR),a=new Date(n.getTime()+12*MILLISECONDS_IN_HOUR);window.plugins.healthkit.querySampleType({startDate:o,endDate:a,sampleType:"HKCategoryTypeIdentifierSleepAnalysis",ascending:"YES"},function(t){if(t&&t.length>0){var i=0;for(var n in t){var o=t[n],r=1===o.value?"Sleeping":"In Bed";if("Sleeping"==r){{var s=moment(o.endDate).diff(o.startDate,"minutes");moment(o.endDate).diff(o.startDate,"hours")}i+=s}}var c=Math.floor(i/60),u=h(e,c),l=O.getHabitDataByHabitId(a,O.SLEEP_HABIT_ID);if(l){var d=O.getHabitValueById(l.habitValueId);u>d.ordinate&&O.updateHabitData(e,l,u,a)}else O.recordHabitData(e,u,void 0,a)}})}function S(){var e=O.getAccountHabitById(O.SLEEP_HABIT_ID);if(e)for(var t=0;7>t;++t)y(e,t)}function D(e,t,i){var n=function(n){if(n&&n.length>0){var o,a=0;for(var r in n){var s=n[r];o||(o=moment(s.startDate).toDate()),a+=s.quantity}var c=Math.floor(a/i),u=h(e,c),l=O.getHabitDataByHabitId(o,t);if(l){var a=O.getHabitValueById(l.habitValueId);u>a.ordinate&&O.updateHabitData(e,l,u,o)}else O.recordHabitData(e,u,void 0,o)}};return n}function L(){var e=O.getAccountHabitById(O.CAFFEINE_HABIT_ID);if(e)for(var t=0;7>t;++t){var i=new Date,n=new Date(i.getTime()-t*MILLISECONDS_IN_DAY);n.setHours(0,0,0,0);var o=new Date(n.getTime()+MILLISECONDS_IN_DAY);window.plugins.healthkit.querySampleType({startDate:n,endDate:o,sampleType:"HKQuantityTypeIdentifierDietaryCaffeine",unit:"mg"},D(e,O.CAFFEINE_HABIT_ID,100))}}function A(){var e=O.getAccountHabitById(O.EXERCISE_HABIT_ID);e&&window.plugins.healthkit.findWorkouts({},function(t){var i={};if(t&&t.length>0)for(var n=0;n<t.length;++n){var o=t[n],a=moment(o.endDate).toDate(),s=o.duration/60,c=r.getDayString(a),u=i[c];u?u.value+=s:(u={value:s,date:a},i[c]=u)}for(var l in i){var d=i[l],f=h(e,d.value),g=O.getHabitDataByHabitId(d.date,O.EXERCISE_HABIT_ID);if(g){var v=O.getHabitValueById(g.habitValueId);f>v.ordinate&&O.updateHabitData(e,g,f,d.date)}else O.recordHabitData(e,f,void 0,d.date)}},function(e){})}var P=!1,O={accountHabits:[],accountHabitValues:[],potentialHabits:[],habitData:{},offlineHabitData:[],recentFeelings:[],MOOD_HABIT_ID:1,SLEEP_HABIT_ID:2,EXERCISE_HABIT_ID:3,EATING_HABIT_ID:4,WATER_HABIT_ID:5,CAFFEINE_HABIT_ID:6,ALCOHOL_HABIT_ID:7,OUTDOORS_HABIT_ID:8,STRESS_HABIT_ID:19,MENSTRUATION_HABIT_ID:20,activeDate:void 0},M=!1;O.requiresHabitDataReload=function(){return M},O.clearHabitDataReload=function(){M=!1};var N=s.getUserPreference("viewed_remove_habit_tooltip"),R=!N||"false"==N,U=!1;O.showRemoveHabitTooltip=function(){return R&&U},O.dismissRemoveHabitTooltip=function(){s.setUserPreference("viewed_remove_habit_tooltip","true"),R=!1};var k=!1;O.setIsEditingHabits=function(e){k=e},O.isEditingHabits=function(){return k},O.removeMoodHabit=function(e){e.habits&&(e.habits=e.habits.slice(0));for(var t=e.habits.length-1;t>=0;--t)e.habits[t].id==O.MOOD_HABIT_ID?e.habits.splice(t,1):e.habits[t].id==O.STRESS_HABIT_ID&&e.habits.splice(t,1)},t.$on("event:pacificaReady",function(){c.getItem("accountHabits",function(e){e&&(O.accountHabits=JSON.parse(e),l())}),c.getItem("habitData",function(e){e&&(O.habitData=JSON.parse(e))}),c.getItem("offlineHabitData",function(e){e&&(O.offlineHabitData=JSON.parse(e))}),c.getItem("recentFeelings",function(e){e&&(O.recentFeelings=JSON.parse(e))})}),O.setActiveDate=function(e){O.activeDate=e},O.getActiveDate=function(){return O.activeDate},O.getHabitSubValueName=function(e,t){for(var i=O.accountHabits[e],n=0;n<i.habitSubValues.length;++n){var o=i.habitSubValues[n];if(o.id==t)return o.display.toLowerCase()}},O.getHabitSubValue=function(e,t){var i;if(e)if(Array.isArray(e))for(var o=0;o<e.length;++o){var a=e[o];a.id==t&&(i=a.valueString)}else{var r=e[t];r&&(i=r.valueString)}if(i||(i=O.getHabitSubValueName(0,t)),i){var s=n.instant(i.toUpperCase());return s==i.toUpperCase()?i.toLowerCase():s.toLowerCase()}return n.instant("UNKNOWN").toUpperCase()},O.updateMoodHabitSubValues=function(e){if(e)for(var t=O.accountHabits[0],i=0;i<e.length;++i){for(var n=e[i],o=!1,a=0;a<t.habitSubValues.length;++a){var r=t.habitSubValues[a];if(r.id==n.id){o=!0;break}}o||t.habitSubValues.push(n)}},O.getHabitSubValues=function(e){for(var t=u(),i="",n=0;n<e.length;++n)n>0&&(i+="&"),i+="ids="+e[n];return o.get(a.serverURL+"/habits/habitSubValues?"+i).success(function(e){O.updateMoodHabitSubValues(e),t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},t.$on("event:online",p),t.$on("event:userContextInitialized",p),O.logout=function(){m()},O.findHabitData=function(e,t){var i=new Date(t.getTime()+MILLISECONDS_IN_DAY);return o.get(a.serverURL+"/habits/habitData?startDate="+r.getDayString(e)+"&endDate="+r.getDayString(i))},O.findPotentialAccountHabits=function(){return o.get(a.serverURL+"/habits/account/potential")},O.setPotentialAccountHabits=function(e){for(var t=0;t<e.length;++t){for(var i=e[t],n=!1,o=0;o<O.potentialHabits.length;++o)if(O.potentialHabits[o].id==i.id){n=!0;break}n||O.potentialHabits.push(i)}},O.getPotentialAccountHabits=function(){return O.potentialHabits},O.setHabitContext=function(e){var t=e.habitValues;O.accountHabits=t,l(),O.accountHabits.sort(function(e,t){return e.ordinate-t.ordinate});for(var i=0;i<O.accountHabits.length;++i)O.ordinate=i;var n=e.habitData;O.habitData={},O.addHabitData(n),P=!0;for(var o=0;o<O.offlineHabitData.length;++o){var a=O.offlineHabitData[o],r=O.getHabitValueById(a.habitValueId),s=O.getAccountHabitById(r.habitId);if(r&&s){var u;u="number"==typeof a.experiencedAt||"string"==typeof a.experiencedAt?new Date(a.experiencedAt):a.experiencedAt,O.setLocalHabitData(s,r.ordinate,a.subValueIds,a.update,u,a.notes,a)}}c.setItem("accountHabits",JSON.stringify(O.accountHabits)),f()},O.getTodaysLastMoodEntryClass=function(){var e=O.getTodaysLastMoodEntry();return e="?"!=e?e.replace(" ",""):""},O.getStressClass=function(e){if(!e)return"";var t=O.getAccountHabitValues("Stress").habitValues,i=t[e.valueInt-1].valueString;return i.replace(/ /g,"")},O.getMoodClass=function(e){if(!e)return"";var t=O.getAccountHabitValues("Mood").habitValues,i=t.length-e.valueInt,n=t[i].valueString;return n.replace(" ","")},O.getTodaysLastMoodEntry=function(){var e=r.getTodayString(),t=O.habitData[e];if(!t)return"?";if(t=t[1],!t||0===t.length)return"?";t.sort(function(e,t){return new Date(t.recordedAt)-new Date(e.recordedAt)});var i=O.getHabitValueById(t[0].habitValueId);return i.valueString},O.addHabitData=function(e){for(var t=0;t<e.length;++t){var i=e[t],n=r.getDayString(new Date(i.experiencedAt)),o=O.getHabitValueById(i.habitValueId);if(o){var a=O.getAccountHabitById(o.habitId),s=O.habitData[n];s||(s=O.habitData[n]={});var c=s[a.id];c||(c=s[a.id]=[]),c.push(i)}}},O.hasHabitContext=function(){return P},O.getAccountHabitValues=function(e){for(var t in O.accountHabits)if(O.accountHabits[t].name==e)return O.accountHabits[t]},O.getAccountHabitValuesById=function(e){for(var t in O.accountHabits)if(O.accountHabits[t].id==e)return O.accountHabits[t]},O.getAccountHabits=function(){return O.accountHabits},O.getAccountHabitById=function(e){for(var t,i=0;i<O.accountHabits.length;++i)if(O.accountHabits[i].id==e){t=O.accountHabits[i];break}return t};var w=[];O.getCreatedHabits=function(){return w},O.clearCreatedHabits=function(){w.length=0};var H=void 0;return O.getHabitsToAdd=function(){return H},O.setHabitsToAdd=function(e){H=e},O.clearHabitsToAdd=function(){H=void 0},O.createHabit=function(e,t){var i=u();return o.post(a.serverURL+"/habits/create",e).success(function(e){t?O.addHabit(e.id).success(function(){O.addLocalHabit(e),i.successCallback&&i.successCallback(e)}).error(function(){i.errorCallback&&i.errorCallback(e)}):(w.push(e),O.potentialHabits.splice(0,0,e),i.successCallback&&i.successCallback(e))}).error(function(){i.errorCallback&&i.errorCallback()}),i},O.editHabit=function(e){var t=u();return o.post(a.serverURL+"/habits/edit",e).success(function(i){var n=0;for(n=0;n<O.accountHabits.length;++n){var o=O.accountHabits[n];if(o.id==e.id)break}O.accountHabits.splice(n,1,i),l(),t.successCallback&&t.successCallback(i)}).error(function(){t.errorCallback&&t.errorCallback()}),t},O.getHabitValueById=function(e,t){var i;return i="object"==typeof e?O.accountHabitValues[t]:O.accountHabitValues[e],i&&i.active?i:void 0},O.getHabitDisplayById=function(e,t){var i=O.getHabitValueById(e,t);return O.getHabitDisplayFromValue(i)},O.getHabitName=function(e){if(1!=e.creatorId)return e.name;var t=n.instant(e.name.toUpperCase());return t==e.name.toUpperCase()?e.name:t},O.getHabitDisplay=function(e,t){var i=e.habitValues[t];return O.getHabitDisplayFromValue(i)},O.getHabitDisplayFromData=function(e){var t=O.getHabitValueById(e.habitValueId);return O.getHabitDisplayFromValue(t)},O.getHabitDisplayFromValue=function(e){if(e){var t=O.getAccountHabitById(e.habitId);if(1!=t.creatorId)return e.valueString;if(t.id==O.MOOD_HABIT_ID){var i="MOOD_"+e.valueString;return i=i.replace(" ","_"),n.instant(i)}if(t.id==O.STRESS_HABIT_ID||e.valueString&&e.valueInt<0){var i="HABITS_VALUES_"+e.valueString;i=i.replace(/ /g,"_").toUpperCase();var o=n.instant(i);return o&&o!=i||(o=e.valueString),o}var a="HABITS_VALUES_"+e.display;a=a.replace(/ /g,"_").toUpperCase();var r=n.instant(a);return r&&r!=a||(r=e.display),(e.valueString?e.valueString:e.valueInt)+" "+(r?r:"")}return n.instant("NO_DATA")},O.hasHabitData=function(e){var t=r.getDayString(e),i=O.habitData[t];return"undefined"!=typeof i},O.getAllMoodHabitData=function(){var e=[];for(var t in O.habitData){var i=O.habitData[t],n=O.accountHabits[0],o=i[n.id];if(o)for(var a=0;a<o.length;++a)e.push(o[a])}return e},O.canSubmitMood=function(){var e=O.getAccountHabitValues("Mood"),t=new Date,i=O.getHabitDataByHabitId(t,e.id);if(i){var n;n="object"==typeof i.experiencedAt?i.experiencedAt.getTime():new Date(i.experiencedAt).getTime();
var o=t.getTime();if(n>o-9e5)return!1}return!0},O.metGoalWithHabitData=function(e){var t=O.getHabitValueById(e.habitValueId),i=O.getAccountHabitById(t.habitId);return O.metGoal(i,t.ordinate)},O.metGoal=function(e,t){return e.goalMinimized?t<=e.goalOrdinal:t>=e.goalOrdinal},O.getHabitDataByHabitId=function(e,t){var i=O.getAccountHabitById(t);if(i){var n=r.getDayString(e),o=O.habitData[n];if(o){var a=o[i.id];if(a){var s=a[0];return s}}}},O.reorderHabits=function(e){for(var t=[],i=0;i<e.length;++i){var n=e[i];if(n.id!=O.MOOD_HABIT_ID&&n.id!=O.STRESS_HABIT_ID){n.ordinate=i+1;var r={habitId:n.id,ordinate:i+1};t.push(r);for(var s=0;s<O.accountHabits.length;++s){var c=O.accountHabits[s];if(c.id==n.id){c.ordinate=n.ordinate;break}}}}return O.accountHabits.sort(function(e,t){return e.ordinate-t.ordinate}),d(),o.post(a.serverURL+"/habits/account/reorder",t)},O.addHabit=function(e,t){return t&&(U=!0),M=!0,o.post(a.serverURL+"/habits/account/add",e)},O.addHabits=function(e,t){return t&&(U=!0),M=!0,o.post(a.serverURL+"/habits/account/addHabits",e)},O.addLocalHabitFromId=function(e){for(var t=0;t<O.accountHabits.length;++t)if(O.accountHabits[t].id==e)return;for(var i,n=0;n<O.potentialHabits.length;++n)if(O.potentialHabits[n].id==e){i=O.potentialHabits[n];break}O.addLocalHabit(i)},O.addLocalHabit=function(e){for(var t=0;t<O.accountHabits.length;++t){var i=O.accountHabits[t];if(i.id==e.id)return}O.accountHabits.push(e),l(),e.ordinate=O.accountHabits.length-1;for(var n=0;n<O.potentialHabits.length;++n)if(O.potentialHabits[n].id==e.id){O.potentialHabits.splice(n,1);break}d()},O.removeHabit=function(e){return M=!0,o.post(a.serverURL+"/habits/account/remove",e)},O.deleteCustomHabit=function(e){var t=u();return o.post(a.serverURL+"/habits/account/delete",e).success(function(){for(var i=0;i<O.potentialHabits.length;++i)if(O.potentialHabits[i].id==e){O.potentialHabits.splice(i,1);break}t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},O.removeLocalHabit=function(e){for(var t,i=0;i<O.accountHabits.length;++i){var n=O.accountHabits[i];if(n.id==e){t=n,O.accountHabits.splice(i,1),O.potentialHabits.push(t);break}}for(var o=0;o<O.accountHabits.length;++o)O.accountHabits[o].ordinate=o;d()},O.deleteHabitData=function(e){var t=u();return o.post(a.serverURL+"/habits/deleteHabitData",{habitDataId:e.id}).success(function(){var i=!1;for(var n in O.habitData){var o=O.habitData[n];for(var a in o){for(var r=o[a],s=0;s<r.length;++s){var c=r[s];if(c.id==e.id){r.splice(s,1),i=!0,0===r.length&&delete o[a];break}}if(i)break}if(i)break}t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},O.updateHabitDataNotes=function(e,t){return o.post(a.serverURL+"/habits/updateNotes",{habitDataId:e,notes:t})},O.buildMultiHabitDataArray=function(e,t,i,n,o,a,r){var s={habitId:t.id,habitValueId:t.habitValues[i].id,experiencedAt:n,goalMet:t.id>1?!!r:!1};o&&(s.habitSubValueIds=o),a&&(s.notes=a),e.push(s)},O.recordMultiHabitData=function(e){var t=u();if(a.isOnline())o.post(a.serverURL+"/habits/multiRecord",e).success(function(e){if(e)for(var i=0;i<e.length;++i){var n=e[i];C(n)}t.successCallback&&t.successCallback(e)}).error(function(){t.errorCallback&&t.errorCallback()});else{for(var n=0;n<e.length;++n){var r=e[n],s=O.getAccountHabitById(r.habitId),c=O.getHabitValueById(r.habitValueId),l=O.setLocalHabitData(s,c.ordinate,r.habitSubValueIds,!1,r.experiencedAt,r.notes,r);b(l)}t.success=function(e){return i(e),t}}return t},O.recordHabitData=function(e,t,i,n,o,a){var r=[];return O.buildMultiHabitDataArray(r,e,t,n,i,o,a),O.recordMultiHabitData(r)},O.buildMultiHabitDataUpdateArray=function(e,t,i,n,o,a,r,s){var c={habitDataId:i.id,habitId:t.id,habitValueId:t.habitValues[n].id,experiencedAt:o,goalMet:t.id>1?!!s:!1};a&&(c.habitSubValueIds=a),r&&(c.notes=r),e.push(c)},O.updateMultiHabitData=function(e){for(var t=u(),n=[],r=0;r<e.length;++r){var s=e[r],c=O.getAccountHabitById(s.habitId),l=O.getHabitValueById(c,s.habitValueId),d=O.setLocalHabitData(c,l.ordinate,s.habitSubValueIds,!0,s.experiencedAt,s.notes,s);n.push(d)}if(a.isOnline())o.post(a.serverURL+"/habits/multiUpdate",e).success(function(){t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()});else{for(var f=0;f<n.length;++f){var s=n[f];T(s)}t.success=function(e){return i(e),t}}return t},O.updateHabitData=function(e,t,i,n,o,a,r){var s=[];return O.buildMultiHabitDataUpdateArray(s,e,t,i,o,n,a,r),O.updateMultiHabitData(s)},O.has5BadConsecutiveMoodRatings=function(){return E(function(e){return 3>=e})},O.has5GoodConsecutiveMoodRatings=function(){return E(function(e){return e>=5})},O.getLocaHabitById=function(e){for(var t in O.habitData){var i=O.habitData[t],n=i[1];if(n)for(var o=0;o<n.length;++o){var a=n[o];if(a.localId&&a.localId==e)return a}}},O.getHabitDataList=function(e,t,i){var n=r.getDayString(t),o=O.habitData[n];o||(o=[],O.habitData[n]=o);var a=o[e.id];return!a&&i&&(a=[],o[e.id]=a),a},O.setLocalHabitData=function(e,t,i,n,o,a,r){var s,c=e.habitValues[t],u=new Date,l=o?o:u,d=O.getHabitDataList(e,l,!0);if(n&&d[0]){if(r)for(var g=0;g<d.length;++g){var v=d[g];if(v.habitDataId&&v.habitDataId==r.habitDataId||v.id&&v.id==r.id){s=v;break}}s||(s=d[0])}else s={experiencedAt:l},d.splice(0,0,s);return s.localId||s.id||(s.localId=generateGUID()),s.habitValueId=c.id,s.habitSubValueIds=i,s.recordedAt=u.getTime(),a&&(s.habitDataNotes?s.habitDataNotes.notes=a:s.habitDataNotes={notes:a}),"object"==typeof s.experiencedAt&&(s.experiencedAtStr=s.experiencedAt.toString()),f(),s},O.updateGoalOrdinal=function(e){var t=u();return o.post(a.serverURL+"/habits/account/updateGoal",{habitId:e.id,goalOrdinal:e.goalOrdinal}).success(function(){d(),t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},O.getRecentFeelings=function(){return O.recentFeelings},O.saveCustomFeelings=function(e){for(var t=u(),i=[],n=0;n<e.length;++n)i.push({valueString:e[n]});return o.post(a.serverURL+"/habits/createSubValues",i).success(function(e){for(var i=0;i<e.length;++i){var n=e[i];I(n)}v(),O.updateMoodHabitSubValues(e),t.successCallback&&t.successCallback(e)}).error(function(){t.errorCallback&&t.errorCallback()}),t},O.saveCustomFeeling=function(e){var t=u();return o.post(a.serverURL+"/habits/createSubValue",{valueString:e}).success(function(e){I(e),v(),O.updateMoodHabitSubValues([e]),t.successCallback&&t.successCallback(e)}).error(function(){t.errorCallback&&t.errorCallback()}),t},O.saveMindfulMinutes=function(e,t,i){window.plugins&&window.plugins.healthkit&&window.plugins.healthkit.requestAuthorization({readTypes:["HKCategoryTypeIdentifierSleepAnalysis","HKQuantityTypeIdentifierDietaryCaffeine","workoutType"],writeTypes:["HKCategoryTypeIdentifierMindfulSession"]},function(){window.plugins.healthkit.saveMindfulMinutes({value:e}),t&&t()},function(){i&&i()})},window.readHealthKitData=function(){S(),L(),A()},O.initHealthKit=function(e,t){window.plugins&&window.plugins.healthkit&&window.plugins.healthkit.available(function(){window.plugins.healthkit.requestAuthorization({readTypes:["HKCategoryTypeIdentifierSleepAnalysis","HKQuantityTypeIdentifierDietaryCaffeine","workoutType"],writeTypes:["HKCategoryTypeIdentifierMindfulSession"]},function(){readHealthKitData(),e&&e()},function(){t&&t()})},function(){})},O}]);var servicesModule=angular.module("httpTimeoutService",[]);servicesModule.factory("HttpTimeoutService",function(){return{}}),servicesModule.factory("timeoutHttpIntercept",["$q","$rootScope",function(){return{request:function(e){return e.timeout=15e3,e}}}]),servicesModule.config(["$httpProvider",function(e){e.interceptors.push("timeoutHttpIntercept")}]);var mod=angular.module("mediaService",[]);mod.factory("MediaService",["$rootScope","$timeout","$translate","authHttp","AccountService","Environment",function(e,t,i,n,o,a){function r(){var e=h.getBackgroundVideos(),t=o.getUserPreference("background_video");t||(t=e[0].code);for(var i=0;i<e.length;++i){var n=e[i];if(n.code==t){h.isDownloaded(n.filename)&&(o.isPremiumEnabled()||n.free)||(n=e[0]),h.setBackgroundVideo(n.filename,n.blurMethod);break}}}function s(e){for(var t=0;t<e.length;t++){var i=e[t];i.isFile&&(h.downloadedFiles[i.name]={filename:i.name,location:i.fullPath,nativeURL:i.nativeURL})}f()}function c(){f()}function u(e,t){window.resolveLocalFileSystemURL(cordova.file.dataDirectory,function(e){e.getDirectory(t,{create:!1,exclusive:!1},function(e){var i=e.createReader();i.readEntries(function(e){s(e),"backgrounds"==t&&r()},c)},function(){f()})})}function l(e){u(e,"meditations"),u(e,"backgrounds")}function d(){}function f(){}function g(e,t,i){function n(e){e.root.getFile(t,{create:!0,exclusive:!1},function(e){i(e)},function(){})}function o(){}window.LocalFileSystem&&window.requestFileSystem(e,0,n,o)}function v(t,i,o,r,s){h.downloadingFiles[o]={filename:o,progress:0,complete:!1},n.get(a.serverURL+t+"?filename="+o).success(function(t){if(window.cordova){var n=b+i+o,a=new FileTransfer;a.onprogress=function(t){if(t.lengthComputable){var i={filename:o,progress:t.loaded/t.total,complete:!1};h.downloadingFiles[o]=i,e.$broadcast("event:downloadProgress",i)}},a.download(t.url,n,function(t){delete h.downloadingFiles[o],h.downloadedFiles[o]={filename:o,location:n,nativeURL:t.nativeURL},e.$broadcast("event:downloadProgress",{filename:o,progress:1,complete:!0}),r&&r()},function(e){s&&s()})}}).error(function(e){})}function p(e,t,i,n,o){h.downloadingFiles[i]||(h.downloadedFiles[i],a.isAndroid()&&cordova.plugins.diagnostic?cordova.plugins.diagnostic.requestRuntimePermission(function(a){switch(a){case cordova.plugins.diagnostic.runtimePermissionStatus.GRANTED:v(e,t,i,n,o);break;case cordova.plugins.diagnostic.runtimePermissionStatus.NOT_REQUESTED:break;case cordova.plugins.diagnostic.runtimePermissionStatus.DENIED:o&&o();break;case cordova.plugins.diagnostic.runtimePermissionStatus.DENIED_ALWAYS:o&&o()}},function(e){},cordova.plugins.diagnostic.runtimePermission.WRITE_EXTERNAL_STORAGE):v(e,t,i,n,o))}function m(t,i){window.resolveLocalFileSystemURL(t,function(t){t&&t.remove(function(){delete h.downloadedFiles[i],e.$broadcast("event:downloadRemoved",i)},function(){})})}var b,h={downloadedFiles:{},downloadingFiles:{}};h.getBackgroundVideos=function(){return[{name:i.instant("BG_VIDEO_OCEAN"),code:"ocean",filename:"ocean.mp4",bgAudio:"Ocean",blurMethod:"light",free:!0},{name:i.instant("BG_VIDEO_OCEAN")+" 2",code:"ocean2",filename:"ocean2.mp4",bgAudio:"Ocean",blurMethod:"light",free:!0},{name:i.instant("BG_VIDEO_TROPICAL"),code:"tropical",filename:"tropical.mp4",bgAudio:"Ocean",blurMethod:"dark",free:!0},{name:i.instant("BG_VIDEO_STREAM"),code:"stream",filename:"forest.mp4",bgAudio:"ForestMorning",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_CLOUDS"),code:"clouds",filename:"clouds.mp4",bgAudio:"Pinknoise",blurMethod:"dark",free:!1},{name:i.instant("BG_VIDEO_CAMPFIRE"),code:"campfire",filename:"campfire.mp4",bgAudio:"campfire",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_MOUNTAINS"),code:"mountains",filename:"mountains.mp4",bgAudio:"ForestMorning",blurMethod:"dark",free:!1},{name:i.instant("BG_VIDEO_WATER"),code:"water",filename:"pond.mp4",bgAudio:"Bach",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_SUNSET"),code:"sunset",filename:"summernight.mp4",bgAudio:"SummerNight",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_WATERFALL"),code:"waterfall",filename:"waterfall.mp4",bgAudio:"Stream",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_LIGHTNING"),code:"thunderstorm",filename:"thunderstorm.mp4",bgAudio:"Thunderstorm",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_FIELD"),code:"field",filename:"field.mp4",bgAudio:"SummerNight",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_LAKE"),code:"lake",filename:"lake.mp4",bgAudio:"ForestMorning",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_REEF"),code:"reef",filename:"reef.mp4",bgAudio:"Pinknoise",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_FLOWERS"),code:"flowers",filename:"flowers.mp4",bgAudio:"ForestMorning",blurMethod:"light",free:!1}]};var T=!1;window.checkExistingFiles=function(){var e=!1;return(!a.isOnline()||window.LocalFileSystem&&!T)&&(e=!0,T=!0,a.isAndroid()?cordova.plugins.diagnostic.getPermissionAuthorizationStatus(function(e){switch(e){case cordova.plugins.diagnostic.permissionStatus.GRANTED:window.requestFileSystem(LocalFileSystem.PERSISTENT,0,l,d);break;case cordova.plugins.diagnostic.permissionStatus.NOT_REQUESTED:break;case cordova.plugins.diagnostic.permissionStatus.DENIED:break;case cordova.plugins.diagnostic.permissionStatus.DENIED_ALWAYS:}},function(e){},cordova.plugins.diagnostic.runtimePermission.READ_EXTERNAL_STORAGE):window.requestFileSystem(LocalFileSystem.PERSISTENT,0,l,d)),e},e.$on("event:userContextInitialized",function(){b=window.cordova?cordova.file.dataDirectory:"";var e=window.checkExistingFiles();e||r()}),e.$on("event:pacificaReady",function(){a.isOnline()||window.checkExistingFiles()});var E={playAudioWhenScreenIsLocked:!1};return h.isNative=function(){return"undefined"!=typeof window.Media},h.loadMeditationMedia=function(e,t){return window.Media?(e=a.isAndroid()?cordova.file.dataDirectory+e:"cdvfile://localhost/library-nosync/"+e,new Media(e,function(){},function(e){},t)):void 0},h.loadMedia=function(e,t,i){var n="";return!e.startsWith("http")&&window.device&&window.device.platform&&"android"==window.device.platform.toLowerCase()&&(n="/android_asset/www/"),window.Media?new Media(n+e,function(){},function(e){},i):void 0},h.loadRecording=function(e,t,i,n,o){var a=function(e){n[i]=new Media(e,function(){},function(e){},o),n[i].setVolume(1)};g(LocalFileSystem.TEMPORARY,t,function(t){a(e.isAndroid()?t.nativeURL:t.fullPath)})},h.setVolume=function(e,t){e&&(e.setVolume?e.setVolume(t):e.volume=t)},h.fadeIn=function(e,i){function n(){r?e.setVolume(i*(a/o)):e.volume=i*(a/o),o>a?(t(n,3e3/o),++a):a=0}if(e){var o=100,a=0,r=h.isNative();n()}},h.fadeOut=function(e,i,n,o){function a(){u?e.setVolume(i*((s-c)/s)):e.volume=i*((s-c)/s),s>c?(t(a,r/s),++c):(c=0,n&&n())}if(e){var r=o?o:3e3,s=100,c=0,u=h.isNative();a()}},h.replayMedia=function(e,t){h.isNative()?(t||(t=E),e.play(t)):(e.load(),e.play())},h.isDownloaded=function(e){var t=h.downloadedFiles[e];return!!t},h.isDownloading=function(e){var t=h.downloadingFiles[e];return!!t},h.getDownloadPercentage=function(e){var t=h.downloadingFiles[e];return t?Math.round(100*t.progress):0},h.getStreamingMeditationURL=function(e){return n.get(a.serverURL+"/media/meditationStream?filename="+e)},h.getStreamingBackgroundURL=function(e){return n.get(a.serverURL+"/media/backgroundStream?filename="+e)},h.downloadBackgroundVideo=function(e,t,i){p("/media/backgroundVideoURL","backgrounds/",e,t,i)},h.setBackgroundVideo=function(e,t){if("ocean.mp4"==e)window.plugins&&window.plugins.bgVideo&&window.plugins.bgVideo.setVideo(void 0);else{if(!h.isDownloaded(e))return;if(window.plugins&&window.plugins.bgVideo){var i=h.downloadedFiles[e].nativeURL;0==i.indexOf("file")&&(i=i.substring(7)),window.plugins.bgVideo.setVideo(i,t)}}},h.downloadMeditationFile=function(e){p("/media/meditationURL","meditations/",e)},h.removeMeditationFile=function(e){var t="meditations/"+e;t=cordova.file.dataDirectory+t,m(t,e)},h.removeBackgroundVideo=function(e){var t="backgrounds/"+e;t=cordova.file.dataDirectory+t,m(t,e)},h}]);var servicesModule=angular.module("notificationService",[]);servicesModule.factory("NotificationService",["$http","$rootScope","$translate","authHttp","Environment","AccountService","HabitsService",function(e,t,i,n,o,a,r){function s(){u.registrationId&&(o.isAndroid()?a.registerGCMToken(u.registrationId,function(e){409==e.status&&u.push.unregister(function(){u.push=void 0,u.registerNotifications()},function(){})}):a.registerAPNSToken(u.registrationId))}var c=1e3,u={push:void 0,registrationId:void 0};return u.registerNotifications=function(e,t){window.PushNotification&&!u.push&&(u.push=PushNotification.init({android:{senderID:"435361669565",icon:"notif",iconColor:"#1ac88d"},ios:{alert:"true",badge:"true",sound:"true",clearBadge:"true"}}),u.push.on("registration",function(t){u.registrationId=t.registrationId,s(),e&&e()}),u.push.on("notification",function(e){e.additionalData&&!e.additionalData.foreground&&e.additionalData.url&&(localStorage.setItem("externalLoadURL",e.additionalData.url),window.checkExternalURL()),o.isIos()&&e.additionalData["content-available"]&&u.push.finish(function(){})}),u.push.on("error",function(e){t&&t()}))},u.queryForHabitReminder=function(e,t){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.notification&&window.cordova.plugins.notification.local){var i=c+e.id;cordova.plugins.notification.local.get(i,function(e){e&&t&&t(e)})}},u.cancelHabitReminder=function(e,t){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.notification&&window.cordova.plugins.notification.local){var i=c+e.id;cordova.plugins.notification.local.cancel(i,function(){t&&t()})}},u.scheduleHabitReminder=function(e,t,n){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.notification&&window.cordova.plugins.notification.local){var o=c+e.id;cordova.plugins.notification.local.schedule({id:o,text:i.instant("HABIT_REMINDER_TEXT").replace("XXXREPLACEXXX",r.getHabitName(e)),at:t,every:"day"},function(e){n&&n(e)})}},u}]);var servicesModule=angular.module("payService",[]),currencyMap={AED:{symbol:"AED",symbol_native:"Ø¯.Ø¥.â€",decimal_digits:2,rounding:0,code:"AED"},AFN:{symbol:"AFN",symbol_native:"Ø‹",decimal_digits:0,rounding:0,code:"AFN"},ALL:{symbol:"ALL",symbol_native:"Lek",decimal_digits:0,rounding:0,code:"ALL"},AMD:{symbol:"AMD",symbol_native:"Õ¤Ö€.",decimal_digits:0,rounding:0,code:"AMD"},AOA:{symbol:"AOA",symbol_native:"Kz",decimal_digits:2,rounding:0,code:"AOA"},ARS:{symbol:"ARS",symbol_native:"$",decimal_digits:2,rounding:0,code:"ARS"},AUD:{symbol:"AU$",symbol_native:"$",decimal_digits:2,rounding:0,code:"AUD"},AWG:{symbol:"AWG",symbol_native:"Afl.",decimal_digits:2,rounding:0,code:"AWG"},AZN:{symbol:"AZN",symbol_native:"Ð¼Ð°Ð½.",decimal_digits:2,rounding:0,code:"AZN"},BAM:{symbol:"BAM",symbol_native:"KM",decimal_digits:2,rounding:0,code:"BAM"},BBD:{symbol:"BBD",symbol_native:"$",decimal_digits:2,rounding:0,code:"BBD"},BDT:{symbol:"BDT",symbol_native:"à§³",decimal_digits:2,rounding:0,code:"BDT"},BGN:{symbol:"BGN",symbol_native:"Ð»Ð².",decimal_digits:2,rounding:0,code:"BGN"},BHD:{symbol:"BHD",symbol_native:"Ø¯.Ø¨.â€",decimal_digits:3,rounding:0,code:"BHD"},BIF:{symbol:"BIF",symbol_native:"FBu",decimal_digits:0,rounding:0,code:"BIF"},BMD:{symbol:"BMD",symbol_native:"$",decimal_digits:2,rounding:0,code:"BMD"},BND:{symbol:"BND",symbol_native:"$",decimal_digits:2,rounding:0,code:"BND"},BOB:{symbol:"BOB",symbol_native:"Bs",decimal_digits:2,rounding:0,code:"BOB"},BRL:{symbol:"R$",symbol_native:"R$",decimal_digits:2,rounding:0,code:"BRL"},BWP:{symbol:"BWP",symbol_native:"P",decimal_digits:2,rounding:0,code:"BWP"},BYR:{symbol:"BYR",symbol_native:"BYR",decimal_digits:0,rounding:0,code:"BYR"},BZD:{symbol:"BZD",symbol_native:"$",decimal_digits:2,rounding:0,code:"BZD"},CAD:{symbol:"CA$",symbol_native:"$",decimal_digits:2,rounding:0,code:"CAD"},CDF:{symbol:"CDF",symbol_native:"FrCD",decimal_digits:2,rounding:0,code:"CDF"},CHF:{symbol:"CHF",symbol_native:"CHF",decimal_digits:2,rounding:.05,code:"CHF"},CLP:{symbol:"CLP",symbol_native:"$",decimal_digits:0,rounding:0,code:"CLP"},CNY:{symbol:"CNÂ¥",symbol_native:"CNÂ¥",decimal_digits:2,rounding:0,code:"CNY"},COP:{symbol:"COP",symbol_native:"$",decimal_digits:0,rounding:0,code:"COP"},CRC:{symbol:"CRC",symbol_native:"â‚¡",decimal_digits:0,rounding:0,code:"CRC"},CVE:{symbol:"CVE",symbol_native:"CVE",decimal_digits:2,rounding:0,code:"CVE"},CZK:{symbol:"CZK",symbol_native:"KÄ",decimal_digits:2,rounding:0,code:"CZK"},DJF:{symbol:"DJF",symbol_native:"Fdj",decimal_digits:0,rounding:0,code:"DJF"},DKK:{symbol:"DKK",symbol_native:"kr",decimal_digits:2,rounding:0,code:"DKK"},DOP:{symbol:"DOP",symbol_native:"$",decimal_digits:2,rounding:0,code:"DOP"},DZD:{symbol:"DZD",symbol_native:"Ø¯.Ø¬.â€",decimal_digits:2,rounding:0,code:"DZD"},EGP:{symbol:"EGP",symbol_native:"Ø¬.Ù….â€",decimal_digits:2,rounding:0,code:"EGP"},ERN:{symbol:"ERN",symbol_native:"Nfk",decimal_digits:2,rounding:0,code:"ERN"},ETB:{symbol:"ETB",symbol_native:"á‰¥áˆ­",decimal_digits:2,rounding:0,code:"ETB"},EUR:{symbol:"â‚¬",symbol_native:"â‚¬",decimal_digits:2,rounding:0,code:"EUR"},GBP:{symbol:"Â£",symbol_native:"Â£",decimal_digits:2,rounding:0,code:"GBP"},GEL:{symbol:"GEL",symbol_native:"GEL",decimal_digits:2,rounding:0,code:"GEL"},GHS:{symbol:"GHS",symbol_native:"GHS",decimal_digits:2,rounding:0,code:"GHS"},GNF:{symbol:"GNF",symbol_native:"FG",decimal_digits:0,rounding:0,code:"GNF"},GTQ:{symbol:"GTQ",symbol_native:"Q",decimal_digits:2,rounding:0,code:"GTQ"},GYD:{symbol:"GYD",symbol_native:"GYD",decimal_digits:0,rounding:0,code:"GYD"},HKD:{symbol:"HK$",symbol_native:"$",decimal_digits:2,rounding:0,code:"HKD"},HNL:{symbol:"HNL",symbol_native:"L",decimal_digits:2,rounding:0,code:"HNL"},HRK:{symbol:"HRK",symbol_native:"kn",decimal_digits:2,rounding:0,code:"HRK"},HUF:{symbol:"HUF",symbol_native:"Ft",decimal_digits:0,rounding:0,code:"HUF"},IDR:{symbol:"IDR",symbol_native:"Rp",decimal_digits:0,rounding:0,code:"IDR"},ILS:{symbol:"â‚ª",symbol_native:"â‚ª",decimal_digits:2,rounding:0,code:"ILS"},INR:{symbol:"â‚¹",symbol_native:"â‚¹",decimal_digits:2,rounding:0,code:"INR"},IQD:{symbol:"IQD",symbol_native:"Ø¯.Ø¹.â€",decimal_digits:0,rounding:0,code:"IQD"},IRR:{symbol:"IRR",symbol_native:"ï·¼",decimal_digits:0,rounding:0,code:"IRR"},ISK:{symbol:"ISK",symbol_native:"kr",decimal_digits:0,rounding:0,code:"ISK"},JMD:{symbol:"JMD",symbol_native:"$",decimal_digits:2,rounding:0,code:"JMD"},JOD:{symbol:"JOD",symbol_native:"Ø¯.Ø£.â€",decimal_digits:3,rounding:0,code:"JOD"},JPY:{symbol:"Â¥",symbol_native:"ï¿¥",decimal_digits:0,rounding:0,code:"JPY"},KES:{symbol:"KES",symbol_native:"Ksh",decimal_digits:2,rounding:0,code:"KES"},KHR:{symbol:"KHR",symbol_native:"áŸ›",decimal_digits:2,rounding:0,code:"KHR"},KMF:{symbol:"KMF",symbol_native:"CF",decimal_digits:0,rounding:0,code:"KMF"},KRW:{symbol:"â‚©",symbol_native:"â‚©",decimal_digits:0,rounding:0,code:"KRW"},KWD:{symbol:"KWD",symbol_native:"Ø¯.Ùƒ.â€",decimal_digits:3,rounding:0,code:"KWD"},KZT:{symbol:"KZT",symbol_native:"â‚¸",decimal_digits:2,rounding:0,code:"KZT"},LBP:{symbol:"LBP",symbol_native:"Ù„.Ù„.â€",decimal_digits:0,rounding:0,code:"LBP"},LKR:{symbol:"LKR",symbol_native:"à¶»à·”.",decimal_digits:2,rounding:0,code:"LKR"},LRD:{symbol:"LRD",symbol_native:"$",decimal_digits:2,rounding:0,code:"LRD"},LTL:{symbol:"LTL",symbol_native:"Lt",decimal_digits:2,rounding:0,code:"LTL"},LVL:{symbol:"LVL",symbol_native:"Ls",decimal_digits:2,rounding:0,code:"LVL"},LYD:{symbol:"LYD",symbol_native:"Ø¯.Ù„.â€",decimal_digits:3,rounding:0,code:"LYD"},MAD:{symbol:"MAD",symbol_native:"Ø¯.Ù….â€",decimal_digits:2,rounding:0,code:"MAD"},MDL:{symbol:"MDL",symbol_native:"MDL",decimal_digits:2,rounding:0,code:"MDL"},MGA:{symbol:"MGA",symbol_native:"MGA",decimal_digits:0,rounding:0,code:"MGA"},MKD:{symbol:"MKD",symbol_native:"MKD",decimal_digits:2,rounding:0,code:"MKD"},MMK:{symbol:"MMK",symbol_native:"K",decimal_digits:0,rounding:0,code:"MMK"},MOP:{symbol:"MOP",symbol_native:"MOP",decimal_digits:2,rounding:0,code:"MOP"},MUR:{symbol:"MUR",symbol_native:"MUR",decimal_digits:0,rounding:0,code:"MUR"},MXN:{symbol:"MX$",symbol_native:"$",decimal_digits:2,rounding:0,code:"MXN"},MYR:{symbol:"MYR",symbol_native:"RM",decimal_digits:2,rounding:0,code:"MYR"},MZN:{symbol:"MZN",symbol_native:"MTn",decimal_digits:2,rounding:0,code:"MZN"},NAD:{symbol:"NAD",symbol_native:"$",decimal_digits:2,rounding:0,code:"NAD"},NGN:{symbol:"NGN",symbol_native:"â‚¦",decimal_digits:2,rounding:0,code:"NGN"},NIO:{symbol:"NIO",symbol_native:"C$",decimal_digits:2,rounding:0,code:"NIO"},NOK:{symbol:"NOK",symbol_native:"kr",decimal_digits:2,rounding:0,code:"NOK"},NPR:{symbol:"NPR",symbol_native:"à¤¨à¥‡à¤°à¥‚",decimal_digits:2,rounding:0,code:"NPR"},NZD:{symbol:"NZ$",symbol_native:"$",decimal_digits:2,rounding:0,code:"NZD"},OMR:{symbol:"OMR",symbol_native:"Ø±.Ø¹.â€",decimal_digits:3,rounding:0,code:"OMR"},PAB:{symbol:"PAB",symbol_native:"B/.",decimal_digits:2,rounding:0,code:"PAB"},PEN:{symbol:"PEN",symbol_native:"S/.",decimal_digits:2,rounding:0,code:"PEN"},PHP:{symbol:"PHP",symbol_native:"â‚±",decimal_digits:2,rounding:0,code:"PHP"},PKR:{symbol:"PKR",symbol_native:"â‚¨",decimal_digits:0,rounding:0,code:"PKR"},PLN:{symbol:"PLN",symbol_native:"zÅ‚",decimal_digits:2,rounding:0,code:"PLN"},PYG:{symbol:"PYG",symbol_native:"â‚²",decimal_digits:0,rounding:0,code:"PYG"},QAR:{symbol:"QAR",symbol_native:"Ø±.Ù‚.â€",decimal_digits:2,rounding:0,code:"QAR"},RON:{symbol:"RON",symbol_native:"RON",decimal_digits:2,rounding:0,code:"RON"},RSD:{symbol:"RSD",symbol_native:"Ð´Ð¸Ð½.",decimal_digits:0,rounding:0,code:"RSD"},RUB:{symbol:"RUB",symbol_native:"Ñ€ÑƒÐ±.",decimal_digits:2,rounding:0,code:"RUB"},RWF:{symbol:"RWF",symbol_native:"FR",decimal_digits:0,rounding:0,code:"RWF"},SAR:{symbol:"SAR",symbol_native:"Ø±.Ø³.â€",decimal_digits:2,rounding:0,code:"SAR"},SDG:{symbol:"SDG",symbol_native:"SDG",decimal_digits:2,rounding:0,code:"SDG"},SEK:{symbol:"SEK",symbol_native:"kr",decimal_digits:2,rounding:0,code:"SEK"},SGD:{symbol:"SGD",symbol_native:"$",decimal_digits:2,rounding:0,code:"SGD"},SOS:{symbol:"SOS",symbol_native:"SOS",decimal_digits:0,rounding:0,code:"SOS"},STD:{symbol:"STD",symbol_native:"Db",decimal_digits:0,rounding:0,code:"STD"},SYP:{symbol:"SYP",symbol_native:"Ù„.Ø³.â€",decimal_digits:0,rounding:0,code:"SYP"},THB:{symbol:"à¸¿",symbol_native:"à¸¿",decimal_digits:2,rounding:0,code:"THB"},TND:{symbol:"TND",symbol_native:"Ø¯.Øª.â€",decimal_digits:3,rounding:0,code:"TND"},TOP:{symbol:"TOP",symbol_native:"T$",decimal_digits:2,rounding:0,code:"TOP"},TRY:{symbol:"TRY",symbol_native:"TL",decimal_digits:2,rounding:0,code:"TRY"},TTD:{symbol:"TTD",symbol_native:"$",decimal_digits:2,rounding:0,code:"TTD"},TWD:{symbol:"NT$",symbol_native:"NT$",decimal_digits:2,rounding:0,code:"TWD"},TZS:{symbol:"TZS",symbol_native:"TSh",decimal_digits:0,rounding:0,code:"TZS"},UAH:{symbol:"UAH",symbol_native:"â‚´",decimal_digits:2,rounding:0,code:"UAH"},UGX:{symbol:"UGX",symbol_native:"USh",decimal_digits:0,rounding:0,code:"UGX"},USD:{symbol:"$",symbol_native:"$",decimal_digits:2,rounding:0,code:"USD"},UYU:{symbol:"UYU",symbol_native:"$",decimal_digits:2,rounding:0,code:"UYU"},UZS:{symbol:"UZS",symbol_native:"UZS",decimal_digits:0,rounding:0,code:"UZS"},VEF:{symbol:"VEF",symbol_native:"Bs.F.",decimal_digits:2,rounding:0,code:"VEF"},VND:{symbol:"â‚«",symbol_native:"â‚«",decimal_digits:0,rounding:0,code:"VND"},XAF:{symbol:"FCFA",symbol_native:"FCFA",decimal_digits:0,rounding:0,code:"XAF"},XOF:{symbol:"CFA",symbol_native:"CFA",decimal_digits:0,rounding:0,code:"XOF"},YER:{symbol:"YER",symbol_native:"Ø±.ÙŠ.â€",decimal_digits:0,rounding:0,code:"YER"},ZAR:{symbol:"ZAR",symbol_native:"R",decimal_digits:2,rounding:0,code:"ZAR"},ZMK:{symbol:"ZMK",symbol_native:"ZK",decimal_digits:0,rounding:0,code:"ZMK"}};servicesModule.factory("PayService",["$http","$sce","$rootScope","$timeout","$analytics","$translate","$ionicPopup","$ionicLoading","$ionicModal","authHttp","Environment","AccountService",function(e,t,i,n,o,a,r,s,c,u,l,d){function f(e){var t=C.products[e];return t?t.title:l.isOnline()?a.instant("UNKNOWN"):"["+a.instant("OFFLINE")+"]"}function g(e){var t=C.products[e];return t?t.price:a.instant(l.isOnline()?"UNKNOWN":"OFFLINE")}function v(e){var t=C.products[e];if(t){if(t.currency)return t.currency;var i=t.title;return i=i.replaceAll(/[0-9,\s\.]/g,"")}return"$"}function p(e){var t=C.products[e];if(t&&t.currency)return t.currency;for(var i in currencyMap){var n=currencyMap[i];if(t.price.indexOf(n.symbol)>=0)return i}return"$"}function m(e){var t=C.products[e];return t?parseFloat(t.numericPrice):0}function b(e){return a.instant(e==T?"ONE_YEAR":"ONE_MONTH")}function h(e){var t=C.products[e];t?(C.isPurchasing=!0,store.order(t.id).error(function(e){s.hide(),C.currentErrorPopup&&C.currentErrorPopup.close(),C.currentErrorPopup=r.alert({title:"Error",template:a.instant("ACCOUNT_UPGRADE_PURCHASE_ERROR")+"<br><br>Code: "+e.code+"<br>Message: "+e.message,okText:a.instant("OK_GOT_IT"),okType:"button-default"}),C.currentErrorPopup.then(function(){C.currentErrorPopup=void 0})})):(C.currentErrorPopup&&C.currentErrorPopup.close(),C.currentErrorPopup=r.alert({title:"Error",template:a.instant("ACCOUNT_UPGRADE_PRODUCT_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"}),C.currentErrorPopup.then(function(){C.currentErrorPopup=void 0}))}var T="Pacifica_Yearly_Subscription_35_99",E="Pacifica_Monthly_Subscription_5_99",C={subscribed:!1,products:{},productVerificationAttempts:{},initializedStore:!1,loadingError:!1,verifyingPayment:!1,isShowingModal:!1,currentErrorPopup:void 0,isPurchasing:!1};return C.getCurrency=function(){return v(T)},C.getYearlyProductName=function(){return f(T)},C.getYearlyProductPrice=function(){return g(T)},C.getYearlyProductPricePerMonth=function(){var e,t=p(T);e=currencyMap[t]?currencyMap[t].symbol:"";var i=m(T);if(i){i=Math.floor(i/12*100)/100;var n=C.getShortTermProductPrice()+"",o=n.indexOf(".")>=0?".":",";return i=(i+"").replace(".",o),0==n.indexOf(e)?e+i.toLocaleString():i.toLocaleString()+e}return void 0},C.getYearlyProductDuration=function(){return b(T)},C.purchaseYearlySubscription=function(){h(T)},C.getShortTermProductName=function(){return f(E)},C.getShortTermProductPrice=function(){return g(E)},C.getShortTermProductDuration=function(){return b(E)},C.purchaseShortTermSubscription=function(){h(E)},C.isStoreLoaded=function(){return C.products[T]||C.isLoadingError()},C.isLoadingError=function(){return C.loadingError},C.isVerifyingPayment=function(){return C.verifyingPayments>0},C.refreshStore=function(){d.canUpgrade()&&(C.initializedStore?store.refresh():C.initStore())},i.$on("event:refreshStore",C.refreshStore),C.initStore=function(){if(l.isAndroid()&&(T="pacifica_yearly_subscription_36",E="pacifica_monthly_subscription_5_99"),!window.store)return void(C.loadingError=!0);if(!C.initializedStore){C.initializedStore=!0,store.verbosity=store.DEBUG,store.validator=function(e,t){d.canUpgrade()&&e.transaction&&(++C.verifyingPayments,d.enablePremiumFeatures(e.transaction,e.id,e.price,function(o){--C.verifyingPayment,s.hide(),"false"==o?(t(!1,{error:{code:store.PURCHASE_EXPIRED,message:a.instant("ACCOUNT_UPGRADE_EXPIRED_MESSAGE")}}),C.productVerificationAttempts[e.transaction.id]=!1):(C.productVerificationAttempts[e.transaction.id]=!0,t(!0,{}),i.$broadcast("event:purchased"),C.isShowingModal&&(s.show({template:a.instant("ACCOUNT_UPGRADE_PURCHASE_VERIFIED")}),n(function(){s.hide()},2e3)))}))},store.register({id:T,alias:"Yearly Subscription",type:store.PAID_SUBSCRIPTION}),store.register({id:E,alias:"Short Term Subscription",type:store.PAID_SUBSCRIPTION});var e=function(){C.isShowingModal&&s.show({template:a.instant("ACCOUNT_UPGRADE_PURCHASE_APPROVED")+"..."})};store.when("Yearly Subscription").approved(function(t){e(t),t.verify()}),store.when("Short Term Subscription").approved(function(t){e(t),t.verify()}),store.when("Yearly Subscription").verified(function(e){e.finish()}),store.when("Short Term Subscription").verified(function(e){e.finish()}),store.when("Yearly Subscription").unverified(function(){}),store.when("Short Term Subscription").unverified(function(){});var t=function(){s.show({template:a.instant("ACCOUNT_UPGRADE_INITIATING_PURCHASE")+"..."})};store.when("Yearly Subscription").initiated(function(e){t(e)}),store.when("Short Term Subscription").initiated(function(e){t(e)});var o=function(){s.hide(),r.alert({title:"Error",template:a.instant("ACCOUNT_UPGRADE_PURCHASE_CANCELED"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})};store.when("Yearly Subscription").cancelled(function(e){o(e)}),store.when("Short Term Subscription").cancelled(function(e){o(e)}),store.when("Yearly Subscription").updated(function(e){C.products[e.id]=e,i.$broadcast("event:storeUpdated")}),store.when("Short Term Subscription").updated(function(e){C.products[e.id]=e,i.$broadcast("event:storeUpdated")
}),store.error(function(e){s.hide(),e.code!=store.ERR_PURCHASE&&C.isShowingModal&&(C.loadingError=!0,C.currentErrorPopup||(C.currentErrorPopup=r.alert({title:"Error",template:a.instant("ACCOUNT_UPGRADE_STORE_ERROR")+"<br><br>Code: "+e.code+"<br>Message: "+e.message,okText:a.instant("OK_GOT_IT"),okType:"button-default"}),C.currentErrorPopup.then(function(){C.currentErrorPopup=void 0})))}),d.canUpgrade()&&store.refresh()}},C.showPremiumModal=function(e,i,u,l){function f(){C.isStoreLoaded()?(C.isVerifyingPayment()||s.hide(),C.isLoadingError()?r.alert({title:"Error",template:a.instant("ACCOUNT_UPGRADE_LOADING_STORE_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"}):d.isPremiumEnabled()&&!d.canUpgrade()&&e.closePremiumModal()):(s.show({template:a.instant("ACCOUNT_UPGRADE_REFRESHING")+"..."}),++g,g>=20?(s.hide(),r.alert({title:"Error",template:a.instant("ACCOUNT_UPGRADE_REFRESH_TIMEOUT_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})):n(f,500))}e.getYearlyProductName=function(){return C.getYearlyProductName()},e.getYearlyProductPrice=function(){return C.getYearlyProductPrice()},e.getYearlyProductPricePerMonth=function(){return C.getYearlyProductPricePerMonth()},e.getYearlyProductDuration=function(){return C.getYearlyProductDuration()},e.showYearlyPricePerMonth=function(){return C.isStoreLoaded()&&e.getYearlyProductPricePerMonth()>0},e.getShortTermProductName=function(){return C.getShortTermProductName()},e.getShortTermProductPrice=function(){return C.getShortTermProductPrice()},e.getShortTermProductDuration=function(){return C.getShortTermProductDuration()},e.getMonthlyTrialText=function(){var e=a.instant("ACCOUNT_UPGRADE_MONTHLY_INCLUDES_TRIAL");return t.trustAsHtml(e)},e.closeThankYouModal=function(){closeModal(e.thankYouModal),e.thankYouModal.remove(),e.thankYouModal=void 0},e.closePremiumModal=function(){C.isShowingModal=!1,e.premiumModal&&(closeModal(e.premiumModal),e.premiumModal.remove(),e.premiumModal=void 0)},e.purchaseYearly=function(){C.purchaseYearlySubscription()},e.purchaseShortTerm=function(){C.purchaseShortTermSubscription()},e.refreshStore=function(){C.refreshStore()},e.$on("event:purchased",function(){C.isPurchasing&&(e.closePremiumModal(),c.fromTemplateUrl("views/account/account.upgradeComplete.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.thankYouModal||(e.thankYouModal=t,openModal(e.thankYouModal))}))}),e.$on("event:storeUpdated",function(){e.$$phase||e.$apply()}),o.eventTrack("premiumWall",{category:"premium",label:u}),c.fromTemplateUrl(l?"views/account/account.upgrade.modal.html":"views/account/account.premiumFeature.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.premiumModal=t,C.isShowingModal=!0,openModal(e.premiumModal)});var g=0;C.isStoreLoaded()||f()},C}]);var servicesModule=angular.module("skillsService",[]);servicesModule.factory("SkillsService",["$http","$rootScope","$translate","$timeout","$ionicModal","authHttp","Environment","AccountService","HabitsService","GoalsService","StorageService","GeneralService","Token",function(e,t,i,n,o,a,r,s,c,u,l){function d(){T.skillContext&&l.setItem("skillContext",JSON.stringify(T.skillContext))}function f(e,t,i,n){if(!i||c.metGoalWithHabitData(t)){var o={actionClass:"health",skillSubClass:e.name.toLowerCase(),actionTitle:c.getHabitName(e),actionTimestamp:t.experiencedAt,data:t};if(e.id==c.MOOD_HABIT_ID){var a=c.getHabitValueById(t.habitValueId);o.actionClass=e.name.toLowerCase(),o.skillSubClass=c.getMoodClass(a),o.actionTitle=c.getHabitDisplayById(e,t.habitValueId)}else if(e.id==c.STRESS_HABIT_ID){var a=c.getHabitValueById(t.habitValueId);o.actionClass=e.name.toLowerCase(),o.skillSubClass=c.getStressClass(a),o.actionTitle=c.getHabitDisplayById(e,t.habitValueId)}n.push(o)}}function g(e,t,i,n){n.push({actionClass:i.actionClass,actionTitle:i.actionTitle,actionTimestamp:t,data:e})}function v(e){for(var t=0;t<e.length;++t){var i=e[t];"Date"!=typeof i.actionTimestamp&&(i.actionTimestamp=new Date(i.actionTimestamp))}e.sort(function(e,t){return t.actionTimestamp-e.actionTimestamp});for(var n=!1,o=0;o<e.length;++o){var a=e[o];"mood"==a.actionClass?(0==o&&(a.showActionButton=!0),n&&(a.moodRespondedTo=!0),n=!1):n=!0}}function p(e){var t={COMPLETED_BREATHING:{activityName:"COMPLETED_BREATHING",actionClass:"deep-breathing",actionTitle:i.instant("COMPLETED_DEEP_BREATHING")},COMPLETED_MUSCLE_RELAXATION:{activityName:"COMPLETED_MUSCLE_RELAXATION",actionClass:"muscle-relaxation",actionTitle:i.instant("COMPLETED_MUSCLE_RELAXATION")},COMPLETED_POSITIVE_VISUALIZATION:{activityName:"COMPLETED_POSITIVE_VISUALIZATION",actionClass:"positive-visualization",actionTitle:i.instant("COMPLETED_POSITIVE_VISUALIZATION")},COMPLETED_MINDFULNESS:{activityName:"COMPLETED_MINDFULNESS",actionTitle:i.instant("COMPLETED_MINDFULNESS")},COMPLETED_RETHINK:{activityName:"COMPLETED_RETHINK",actionClass:"thought",actionTitle:i.instant("COMPLETED_THINKING_TRAPS")},COMPLETED_JOURNAL:{activityName:"COMPLETED_JOURNAL",actionClass:"journal",actionTitle:i.instant("COMPLETED_JOURNAL")},COMPLETED_UNGUIDED_MEDITATION:{activityName:"COMPLETED_UNGUIDED_MEDITATION",actionClass:"unguided-meditation",actionTitle:i.instant("COMPLETED_UNGUIDED_MEDITATION")},COMPLETED_SS_SOCIAL_SITUATIONS:{activityName:"COMPLETED_SS_SOCIAL_SITUATIONS",actionClass:"social-situations",actionTitle:i.instant("COMPLETED_SS_SOCIAL_SITUATIONS")},COMPLETED_SS_FLYING:{activityName:"COMPLETED_SS_FLYING",actionClass:"flying",actionTitle:i.instant("COMPLETED_SS_FLYING")},COMPLETED_SS_PUBLIC_SPEAKING:{activityName:"COMPLETED_SS_PUBLIC_SPEAKING",actionClass:"public-speaking",actionTitle:i.instant("COMPLETED_SS_PUBLIC_SPEAKING")},COMPLETED_SS_PUBLIC_TRANSIT:{activityName:"COMPLETED_SS_PUBLIC_TRANSIT",actionClass:"public-transit",actionTitle:i.instant("COMPLETED_SS_PUBLIC_TRANSIT")},COMPLETED_MINDFUL_SENSES:{activityName:"COMPLETED_MINDFUL_SENSES",actionClass:"mindful-senses",actionTitle:i.instant("COMPLETED_MINDFUL_SENSES")},COMPLETED_MINDFUL_BREATHE:{activityName:"COMPLETED_MINDFUL_BREATHE",actionClass:"mindful-breathe",actionTitle:i.instant("COMPLETED_MINDFUL_BREATHE")},COMPLETED_MINDFUL_OBSERVE:{activityName:"COMPLETED_MINDFUL_OBSERVE",actionClass:"mindful-observe",actionTitle:i.instant("COMPLETED_MINDFUL_OBSERVE")},COMPLETED_MINDFUL_BODY_SCAN:{activityName:"COMPLETED_MINDFUL_BODY_SCAN",actionClass:"mindful-body-scan",actionTitle:i.instant("COMPLETED_MINDFUL_BODY_SCAN")},COMPLETED_MINDFUL_WALK:{activityName:"COMPLETED_MINDFUL_WALK",actionClass:"mindful-walk",actionTitle:i.instant("COMPLETED_MINDFUL_WALK")},COMPLETED_CALM_BREATHE:{activityName:"COMPLETED_CALM_BREATHE",actionClass:"calm-breathe",actionTitle:i.instant("COMPLETED_CALM_BREATHE")},COMPLETED_CALM_MIND:{activityName:"COMPLETED_CALM_MIND",actionClass:"calm-mind",actionTitle:i.instant("COMPLETED_CALM_MIND")},COMPLETED_PANIC_EMERGENCY:{activityName:"COMPLETED_PANIC_EMERGENCY",actionClass:"panic-emergency",actionTitle:i.instant("COMPLETED_PANIC_EMERGENCY")},COMPLETED_SLEEP:{activityName:"COMPLETED_SLEEP",actionClass:"sleep",actionTitle:i.instant("COMPLETED_SLEEP")},COMPLETED_GRATITUDE:{activityName:"COMPLETED_GRATITUDE",actionClass:"gratitude",actionTitle:i.instant("COMPLETED_GRATITUDE")},COMPLETED_BECOMING_THE_TREE:{activityName:"COMPLETED_BECOMING_THE_TREE",actionClass:"becoming-the-tree",actionTitle:i.instant("COMPLETED_BECOMING_THE_TREE")},COMPLETED_DIFFICULT_EXPERIENCE:{activityName:"COMPLETED_DIFFICULT_EXPERIENCE",actionClass:"difficult-experience",actionTitle:i.instant("COMPLETED_DIFFICULT_EXPERIENCE")},COMPLETED_SELF_COMPASSION:{activityName:"COMPLETED_SELF_COMPASSION",actionClass:"self-compassion",actionTitle:i.instant("COMPLETED_SELF_COMPASSION")},COMPLETED_EMPATHY:{activityName:"COMPLETED_EMPATHY",actionClass:"empathy",actionTitle:i.instant("COMPLETED_EMPATHY")},COMPLETED_DEFUSION:{activityName:"COMPLETED_DEFUSION",actionClass:"intense-emotions",actionTitle:i.instant("COMPLETED_DEFUSION")},COMPLETED_POSITIVE_RETHINK:{activityName:"COMPLETED_POSITIVE_RETHINK",actionClass:"thoughts",actionTitle:i.instant("COMPLETED_POSITIVE_RETHINK")},POSTED_TO_COMMUNITY:{activityName:"POSTED_TO_COMMUNITY",actionClass:"social",actionTitle:i.instant("POSTED_TO_COMMUNITY")},COMPLETED_GRATITUDE_JOURNAL:{activityName:"COMPLETED_GRATITUDE_JOURNAL",actionClass:"journal",actionTitle:i.instant("COMPLETED_GRATITUDE_JOURNAL")},COMPLETED_POSITIVITY_JOURNAL:{activityName:"COMPLETED_POSITIVITY_JOURNAL",actionClass:"journal",actionTitle:i.instant("COMPLETED_POSITIVITY_JOURNAL")}};return e&&(t.COMPLETED_EXPERIMENT={activityName:"COMPLETED_EXPERIMENT",actionClass:"goals",actionTitle:i.instant("COMPLETED_GOAL")}),t}function m(e,a){function r(e,t){return e=parseInt(e),t=parseInt(t),Math.floor(Math.random()*(t-e+1))+e}function c(e){$.each($(".activityTitle"),function(){for(var t=$(this).width()/50*15,i=0;t>=i;i++){var n=r(30,60);$(this).append('<span class="levelParticle '+e+'" style="bottom:'+r(20,50)+"%; left:"+r(1,99)+"%;width:"+n+"px; height:"+n+"px; font-size:"+n+"px; animation-delay: "+r(0,30)/10+'s;"></span>')}})}if(!(e>=a.length||s.isUMNUser())){var u=t.$new(!0);u.newLevel=a[e].type,u.closeNewLevelModal=function(){++e,e>=a.length?(closeModal(l),l.remove()):(u.newLevel=a[e].type,$(".levelParticle").remove(),n(function(){c(a[e].type)}))},u.getLevelUpButtonText=function(){var t=e>=a.length-1?"DONE":"NEXT";return i.instant(t)},u.getLevelUpTitle=function(){var t=Math.min(e,a.length-1),n=i.instant("ACHIEVED_ACTIVITY_LEVEL");return n=n.replace("XXXLEVELXXX",a[t].level)},u.getLevelUpActivity=function(){var t,n=Math.min(e,a.length-1),o=a[n].type;return"goals"==o?t="EXPERIMENTS_ACTIVITY":"habits"==o?t="HEALTH_ACTIVITY":"relax"==o?t="RELAX_ACTIVITY":"thoughts"==o?t="THOUGHTS_ACTIVITY":"social"==o&&(t="SOCIAL_ACTIVITY"),i.instant(t)};var l=void 0;o.fromTemplateUrl("views/skills/levelUp.modal.html",{scope:u,animation:"slide-in-up"}).then(function(t){l=t,openModal(l),n(function(){c(a[e].type)})})}}function b(e){var t=T.skillContext,i=[];return e&&t&&(e.goalsLevel>t.goalsLevel&&i.push({type:"goals",level:e.goalsLevel}),e.habitsLevel>t.habitsLevel&&i.push({type:"habits",level:e.habitsLevel}),e.relaxLevel>t.relaxLevel&&i.push({type:"relax",level:e.relaxLevel}),e.socialLevel>t.socialLevel&&i.push({type:"social",level:e.socialLevel}),e.thoughtsLevel>t.thoughtsLevel&&i.push({type:"thoughts",level:e.thoughtsLevel}),i.length>0&&m(0,i)),i.length}function h(){var e=createPromise();return r.isOnline()?a.get(r.serverURL+"/skills/context").success(function(t){e.successCallback&&e.successCallback(t)}).error(function(){e.errorCallback&&e.errorCallback()}):n(function(){e.successCallback&&e.successCallback(T.skillContext)}),e}var T={skillContext:void 0,todaysActions:[],todaysActionDate:new Date,suggestedActivityId:void 0};return t.$on("event:pacificaReady",function(){l.getItem("skillContext",function(e){if(e){var t=JSON.parse(e);T.skillContext=t}})}),T.logout=function(){T.skillContext=void 0,T.todaysActions=[],T.todaysActionDate=new Date,T.suggestedActivityId=void 0},T.getSuggestedActivityId=function(){return T.suggestedActivityId},T.setSuggestedActivityId=function(e){T.suggestedActivityId=e},T.getTodaysActions=function(){return T.todaysActions},T.setSkillContext=function(e){if(s.isUMNUser())return 0;var t=b(e);return T.skillContext=e,d(),t},T.getSkillLevel=function(e){var t=T.skillContext;return t?"goals"==e?t.goalsLevel:"health"==e?t.habitsLevel:"relax"==e?t.relaxLevel:"thoughts"==e?t.thoughtsLevel:"social"==e?t.socialLevel:0:0},T.createActionsWithData=function(e,t){var i=[];if(e)for(var n=0;n<e.length;++n){var o=e[n],a=c.getHabitValueById(o.habitValueId),r=c.getAccountHabitById(a.habitId);f(r,o,!1,i)}var s=p(!0);if(t)for(var u=0;u<t.length;++u){var l=t[u],d=s[l.activityName];d&&g(l,l.date,d,i)}return v(i),i},T.recreateTodaysActions=function(){var e=new Date;T.todaysActions=[],T.todaysActionDate=e;for(var t=c.getAccountHabits(),i=0;i<t.length;++i){var n=t[i],o=c.getHabitDataList(n,e);if(o)for(var a=0;a<o.length;++a){var r=o[a];f(n,r,!0,T.todaysActions)}}var l=u.getTodaysAchievedGoals();if(l)for(var d=0;d<l.length;++d){var m=l[d];T.todaysActions.push({actionClass:"goals",actionTitle:m.title,actionTimestamp:m.achievedRecordedAt})}var b=p(!1);for(var h in b){var E=b[h],C=s.getActivities(E.activityName);if(C)for(var _=0;_<C.length;++_){var I=C[_];g(I,I.recordedAt,E,T.todaysActions)}}v(T.todaysActions)},T.checkForLevelUp=function(e,t){s.isUMNUser()?n(function(){e&&e(0)}):h().success(function(t){var i=T.setSkillContext(t);e&&e(i)}).error(function(){t&&t()})},T}]);var servicesModule=angular.module("storageService",[]);servicesModule.factory("StorageService",["$translate","Environment",function(e,t){function i(e,t){var i=localStorage.getItem(e);t(i)}function n(e,t){localStorage.setItem(e,t)}function o(e){localStorage.removeItem(e)}function a(e){var t=localStorage.getItem("token");if(t&&t.length>0)for(var i=0,n=localStorage.length;n>i;++i){var o=localStorage.key(i);if("counter"!=o&&0!=o.indexOf("_")){var a=localStorage.getItem(o),r=function(t){localStorage.removeItem(t),--u,0==u&&e&&e()};++u,c.setItem(o,a,r,function(){--u})}}else e&&e()}function r(e){c.secureStorage.init(function(){s=!0,c.canEncrpyt=!0,a(e)},function(t){s=!0,c.canEncrpyt=!1,e&&e()},"pacifica")}var s=!1,c={canEncrpyt:!1,secureStorage:void 0,keys:{}};c.clear=function(){if(t.isStorageAllowed()&&s)if(c.canEncrpyt)for(var e in c.keys)c.removeItem(e),delete c[e];else localStorage.clear()},c.getItem=function(e,n){t.isStorageAllowed()&&s&&(c.canEncrpyt?c.secureStorage.get(function(e){n(e)},function(e){n(void 0)},e):i(e,n))},c.setItem=function(e,i,o){t.isStorageAllowed()&&s&&(c.canEncrpyt?c.secureStorage.set(function(e){c.keys[e]=e,o&&o(e)},function(e){},e,i):n(e,i))},c.removeItem=function(e){t.isStorageAllowed()&&s&&(c.canEncrpyt?c.secureStorage.remove(function(){},function(e){},e):o(e))};var u=0;return c.initialize=function(e){s||(window.cordova&&window.cordova.plugins&&window.cordova.plugins.SecureStorage?(c.secureStorage=new cordova.plugins.SecureStorage("pacifica"),t.isAndroid()?c.secureStorage.isKeyguardSecure(function(t){t?r(e):(c.canEncrpyt=!1,s=!0,e&&e())}):r(e)):(s=!0,e&&e()))},c}]);var tokenModule=angular.module("tokenProvider",[]);tokenModule.provider("Token",function(){var e={token:void 0};return e.setToken=function(t){e.token=t},e.getToken=function(){return e.token},e.hasToken=function(){if(window.Cookies){var t=Cookies.get("SessionExpires");return!!t}return!!e.token},{setToken:function(t){e.setToken(t)},getToken:function(){return e.getToken()},hasToken:function(){return e.hasToken()},$get:function(){return e}}}),tokenModule.factory("TokenService",["$rootScope","$timeout","StorageService","Token","Environment",function(e,t,i,n,o){function a(){i.getItem("token",function(i){i&&n.setToken(i),t(function(){e.$broadcast("event:pacificaReady")})})}var r={};return o.isWeb()||e.$on("event:pacificaInitialize",a),r.getToken=function(){return n.getToken()},r.hasToken=function(){return n.hasToken()},r.update=function(e){n.setToken(e),i.setItem("token",e)},r.clear=function(){n.setToken(void 0),i.removeItem("token"),window.Cookies&&Cookies.remove("SessionExpires")},r}]);var servicesModule=angular.module("webappEnvironmentService",[]);servicesModule.factory("Environment",["$rootScope","$translate",function(){var e={serverURL:"/app",websocketURL:"wss://"+window.location.host.indexOf("www.thinkpacifica.com")<0},t={appVersion:"0.0.1"};return e.isOnline=function(){return!0},e.isDebug=function(){return window.location.host.indexOf("www.thinkpacifica.com")<0},e.isWeb=function(){return!0},e.isDevelopment=function(){return window.location.host.indexOf("www.thinkpacifica.com")<0},e.isStorageAllowed=function(){return!1},e.getAppVersion=function(){return t.appVersion},e.getGATrackingCode=function(){return e.gaTrackingCode},e}]);